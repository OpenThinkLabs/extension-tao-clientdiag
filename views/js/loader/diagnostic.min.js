!function(){"use strict";var loaderScript=document.getElementById("amd-loader"),configUrl=loaderScript.getAttribute("data-config"),bundle=loaderScript.getAttribute("data-bundle"),loadController=function(){var controllerOptions={},controllerPath=loaderScript.getAttribute("data-controller"),params=loaderScript.getAttribute("data-params");try{controllerOptions=JSON.parse(params)}catch(err){controllerOptions={}}window.require([controllerPath],function(controller){var startController=function(){window.started||(window.started=!0,controller.start(controllerOptions))};document.addEventListener("readystatechange",startController,!1),
"complete"===document.readyState&&startController()})};window.require([configUrl],function(){window.loadBundles||(window.loaded={},window.loadBundles=function(bundles){bundles=(bundles=(bundles=bundles||[]).concat(window.bundles)).filter(function(item,index){return item&&bundles.indexOf(item)===index&&!0!==window.loaded[item]}),require(bundles,function(){bundles.forEach(function(item){window.loaded[item]=!0}),loadController()})}),bundle||window.bundles&&window.bundles.length?window.loadBundles([bundle]):loadController()})}(),define("loader/bootstrap",function(){}),function(global,factory){
"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("lodash")):"function"==typeof define&&define.amd?define("core/format",["lodash"],factory):(global=global||self)["core/format"]=factory(global._)}(this,function(_){"use strict";_=_&&_.hasOwnProperty("default")?_.default:_;var pattern=/(%[sdj])/g;return function(message){var replacements=Array.prototype.slice.call(arguments,1);return _.reduce(message.match(pattern),function(acc,match,index){var replacement="";if(void 0!==replacements[index]){switch(match){case"%d":replacement=Number(replacements[index]);break;case"%j":try{replacement=JSON.stringify(replacements[index]).replace(
/"/g,"")}catch(e){}break;default:replacement=replacements[index]}message=message.replace(match,replacement)}return message},message)}}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define("core/promise",factory):(global=global||self)["core/promise"]=factory()}(this,function(){"use strict";return Promise}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("core/format"),require("core/promise")):"function"==typeof define&&define.amd?define("core/logger/api",["lodash","core/format",
"core/promise"],factory):(global=global||self)["core/logger/api"]=factory(global._,global["core/format"],global["core/promise"])}(this,function(_,format,Promise){"use strict";_=_&&_.hasOwnProperty("default")?_.default:_,format=format&&format.hasOwnProperty("default")?format.default:format,Promise=Promise&&Promise.hasOwnProperty("default")?Promise.default:Promise;function loggerFactory(name,minLevel,fields){var baseRecord,logger;if(!_.isString(name)||_.isEmpty(name))throw new TypeError("A logger needs a name");return _.isPlainObject(minLevel)&&"undefined"==typeof field&&(fields=minLevel,minLevel=defaultLevel),baseRecord=_.defaults(fields||{},{name:name,pid:1,
hostname:navigator.userAgent}),logger={log:function(level,recordFields,message){var record,err,rest=[],time=(new Date).toISOString();if(!1!==loggerFactory.providers&&checkMinLevel(minLevel||defaultLevel,level))return rest=_.isString(recordFields)||recordFields instanceof Error?(message=recordFields,recordFields={},[].slice.call(arguments,2)):[].slice.call(arguments,3),record={level:getLevel(level),v:0,time:time},checkMinLevel(levels.error,level)||message instanceof Error?(err=message instanceof Error?message:(message=_.isObject(message)?JSON.stringify(message):message,new Error(message)),record.msg=err.message,record.err=err):record.msg=format.apply(null,[
message].concat(rest)),_.merge(record,baseRecord,recordFields),logQueue.push(record),loggerFactory.flush(),this},level:function(value){return void 0!==value?(minLevel=getLevelNum(value),this):getLevel(minLevel)},child:function(childFields){return loggerFactory(name,minLevel,_.defaults(childFields,baseRecord))}},_.reduce(levels,function(target,level,levelName){return target[levelName]=_.partial(logger.log,level),target},logger)}var defaultLevel="info",levels={fatal:60,error:50,warn:40,info:30,debug:20,trace:10},logQueue=[],getLevel=function(level){return void 0===level||_.isString(level)&&!_.has(levels,level)?defaultLevel:_.isNumber(level)?_.findKey(levels,
function(l){return l===level})||defaultLevel:level},getLevelNum=function(level){return _.isString(level)&&_.has(levels,level)?levels[level]:_.isNumber(level)&&_.contains(levels,level)?level:levels[defaultLevel]},checkMinLevel=function(minLevel,level){return getLevelNum(level)>=getLevelNum(minLevel)};return loggerFactory.levels=levels,loggerFactory.providers=!1,loggerFactory.load=function(providerConfigs){var self=this,modules=[];return this.providers=[],new Promise(function(resolve,reject){_.forEach(providerConfigs,function(providerConfig,providerName){modules.push(providerName)}),require(modules,function(){var loadedProviders=[].slice.call(arguments)
;_.forEach(loadedProviders,function(provider,moduleKey){try{self.register(provider,providerConfigs[modules[moduleKey]])}catch(err){reject(err)}}),self.flush(),resolve()},reject)})},loggerFactory.register=function(provider,providerConfig){if(!_.isPlainObject(provider)||!_.isFunction(provider.log))throw new TypeError("A log provider is an object with a log method");provider.checkMinLevel=checkMinLevel,_.isFunction(provider.setConfig)&&provider.setConfig(providerConfig),this.providers=this.providers||[],this.providers.push(provider)},loggerFactory.flush=function(){_.isArray(this.providers)&&0<this.providers.length&&(_.forEach(logQueue,function(message){
_.forEach(loggerFactory.providers,function(provider){provider.log.call(provider,message)})}),logQueue=[])},loggerFactory.setDefaultLevel=function(level){return defaultLevel=getLevel(level)},loggerFactory}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("module"),require("core/logger/api")):"function"==typeof define&&define.amd?define("core/logger",["lodash","module","core/logger/api"],factory):(global=global||self)["core/logger"]=factory(global._,global.module,global["core/logger/api"])}(this,function(_,module,loggerFactory){"use strict";_=_&&_.hasOwnProperty("default"
)?_.default:_,module=module&&module.hasOwnProperty("default")?module.default:module;var defaultConfig={level:(loggerFactory=loggerFactory&&loggerFactory.hasOwnProperty("default")?loggerFactory.default:loggerFactory).levels.warn,loggers:{"core/logger/console":{level:"warn"}}},config=_.defaults(module.config()||{},defaultConfig),logger=loggerFactory("core/logger");return loggerFactory.setDefaultLevel(config.level),loggerFactory.load(config.loggers),window.onerror=function(msg,url,line,col,error){logger.error("Caught[via window.onerror]: '"+msg+"' from "+url+":"+line+":"+col)},window.setTaoLogLevel=function(level){return loggerFactory.setDefaultLevel(level)},
loggerFactory}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("core/promise"),require("lib/uuid"),require("core/logger")):"function"==typeof define&&define.amd?define("core/eventifier",["lodash","core/promise","lib/uuid","core/logger"],factory):(global=global||self)["core/eventifier"]=factory(global._,global["core/promise"],global["lib/uuid"],global["core/logger"])}(this,function(_,Promise,uuid,loggerFactory){"use strict";_=_&&_.hasOwnProperty("default")?_.default:_,Promise=Promise&&Promise.hasOwnProperty("default")?Promise.default:Promise,uuid=uuid&&uuid.hasOwnProperty(
"default")?uuid.default:uuid,loggerFactory=loggerFactory&&loggerFactory.hasOwnProperty("default")?loggerFactory.default:loggerFactory;var defaultNs="@",eventifierLogger=loggerFactory("core/eventifier");function getEventNames(eventNames){return!_.isString(eventNames)||_.isEmpty(eventNames)?[]:_(eventNames.split(/\s/g)).compact().uniq().value()}function getName(eventName){return-1<eventName.indexOf(".")?eventName.substr(0,eventName.indexOf(".")):eventName}function getNamespace(eventName){return-1<eventName.indexOf(".")?eventName.substr(eventName.indexOf(".")+1):defaultNs}return function(target){var targetName,logger,stoppedEvents,eventHandlers={},
getHandlers=function(eventName,type){var name=getName(eventName),ns=getNamespace(eventName);return type=type||"between",eventHandlers[ns]=eventHandlers[ns]||{},eventHandlers[ns][name]=eventHandlers[ns][name]||{before:[],between:[],after:[]},eventHandlers[ns][name][type]},eventApi={on:function(eventNames,handler){return _.isFunction(handler)&&_.forEach(getEventNames(eventNames),function(eventName){getHandlers(eventName).push(handler)}),this},off:function(eventNames){return _.forEach(getEventNames(eventNames),function(eventName){var offNamespaces,name=getName(eventName),ns=getNamespace(eventName);ns&&!name?"*"===ns?((offNamespaces={}
)[defaultNs]=eventHandlers[defaultNs],eventHandlers=offNamespaces):eventHandlers[ns]={}:_.forEach(eventHandlers,function(nsHandlers,namespace){!nsHandlers[name]||ns!==defaultNs&&ns!==namespace||(nsHandlers[name]={before:[],between:[],after:[]})})}),this},removeAllListeners:function(){return eventHandlers={},this},trigger:function(eventNames){var self=this,args=[].slice.call(arguments,1);function triggerBetween(allHandlers,event){shouldStop(event.name)?logHandlerStop("before",event):triggerHandlers(allHandlers.between,event).then(function(){!function(handlers,event){shouldStop(event.name)?logHandlerStop("on",event):triggerHandlers(handlers,event).then(
function(){shouldStop(event.name)&&logHandlerStop("after",event)}).catch(function(err){logHandlerStop("after",event,err)})}(allHandlers.after,event)}).catch(function(err){logHandlerStop("on",event,err)})}function triggerHandlers(handlers,event){var pHandlers;return pHandlers=handlers.map(function(handler){return shouldStop(event.name)?Promise.reject():handler.apply(self,args)}),Promise.all(pHandlers)}function logHandlerStop(stoppedIn,event,err){err instanceof Error&&logger.error(err),logger.trace({err:err,event:event.name,stoppedIn:stoppedIn},event.name+" handlers stopped")}function shouldStop(name){return stoppedEvents[name]}return stoppedEvents={},
_.forEach(getEventNames(eventNames),function(eventName){var ns=getNamespace(eventName),name=getName(eventName),mergedHandlers=_(eventHandlers).filter(function(nsHandlers,namespace){return nsHandlers[name]&&(ns===defaultNs||ns===namespace||"*"===namespace)}).reduce(function(acc,nsHandlers){return acc.before=acc.before.concat(nsHandlers[name].before),acc.between=acc.between.concat(nsHandlers[name].between),acc.after=acc.after.concat(nsHandlers[name].after),acc},{before:[],between:[],after:[]});logger.trace({event:eventName,args:args},"trigger %s",eventName),mergedHandlers&&function(allHandlers,name,ns){var event={name:name,namespace:ns}
;allHandlers.before.length?function(handlers,event){var pHandlers,beforeArgs=args.slice();return beforeArgs.unshift(event),pHandlers=handlers.map(function(handler){var value=!shouldStop(event.name)&&handler.apply(self,beforeArgs);return!1===value?Promise.reject():value}),Promise.all(pHandlers)}(allHandlers.before,event).then(function(){triggerBetween(allHandlers,event)}).catch(function(err){logHandlerStop("before",event,err)}):triggerBetween(allHandlers,event)}(mergedHandlers,name,ns)}),this},before:function(eventNames,handler){return _.isFunction(handler)&&_.forEach(getEventNames(eventNames),function(eventName){getHandlers(eventName,"before").push(handler)}
),this},after:function(eventNames,handler){return _.isFunction(handler)&&_.forEach(getEventNames(eventNames),function(eventName){getHandlers(eventName,"after").push(handler)}),this},stopEvent:function(name){_.isString(name)&&!_.isEmpty(name.trim())&&(stoppedEvents[name.trim()]=!0)},spread:function(destination,eventNames){var self=this;return destination&&_.isFunction(destination.trigger)&&(_.isString(eventNames)&&(eventNames=getEventNames(eventNames)),_.forEach(eventNames,function(eventName){self.on(eventName,function(){var args=[eventName].concat([].slice.call(arguments));destination.trigger.apply(destination,args)})})),this}};return targetName=(
target=target||{}).name||target.id||target.serial||uuid(6),logger=eventifierLogger.child({target:targetName}),_(eventApi).functions().forEach(function(method){_.isFunction(target[method])&&eventifierLogger.warn("The target object has already a method named "+method,target),target[method]=function(){var args=[].slice.call(arguments);return eventApi[method].apply(target,args)}}),target}}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define("util/regexEscape",factory):(global=global||self)["util/regexEscape"]=factory()}(this,function(){"use strict";return function(s
){return s.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("util/regexEscape")):"function"==typeof define&&define.amd?define("util/wrapLongWords",["util/regexEscape"],factory):(global=global||self)["util/wrapLongWords"]=factory(global["util/regexEscape"])}(this,function(regexEscape){"use strict";regexEscape=regexEscape&&regexEscape.hasOwnProperty("default")?regexEscape.default:regexEscape;var getCutTerm=function(longWord,chunkExp){for(var cutTerms=longWord.match(chunkExp),i=cutTerms.length,oldFirst="",newFirst="",offenders=[".",":",";"];i--;
)newFirst=cutTerms[i].charAt(0),-1<offenders.indexOf(newFirst)&&(cutTerms[i]=cutTerms[i].substr(1)),-1<offenders.indexOf(oldFirst)&&(cutTerms[i]=cutTerms[i]+oldFirst),oldFirst=newFirst;return cutTerms.join(" ")};return function(str,threshold){str=str.toString().replace(/([\w])</g,"$1 <");for(var cut,chunkExp=new RegExp(".{1,"+threshold+"}","g"),longWords=str.match(new RegExp("[\\S]{"+threshold+",}","g"))||[],i=longWords.length;i--;)cut=getCutTerm(longWords[i],chunkExp),str=str.replace(new RegExp(regexEscape(longWords[i]),"g"),cut);return str}}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(
):"function"==typeof define&&define.amd?define("util/encode",factory):(global=global||self)["util/encode"]=factory()}(this,function(){"use strict";var _reQuot=/"/g,_reApos=/'/g,encodeHTML=function(html){return document.createElement("a").appendChild(document.createTextNode(html)).parentNode.innerHTML};return{html:encodeHTML,attribute:function(html){return encodeHTML(html).replace(_reQuot,"&quot;").replace(_reApos,"&apos;")},encodeBase64:function(str){return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,function(match,p1){return String.fromCharCode("0x"+p1)}))},decodeBase64:function(str){return decodeURIComponent(Array.prototype.map.call(atob(str),
function(c){return"%"+("00"+c.charCodeAt(0).toString(16)).slice(-2)}).join(""))}}}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("core/promise"),require("core/eventifier"),require("lib/uuid")):"function"==typeof define&&define.amd?define("core/promiseQueue",["lodash","core/promise","core/eventifier","lib/uuid"],factory):(global=global||self)["core/promiseQueue"]=factory(global._,global["core/promise"],global["core/eventifier"],global["lib/uuid"])}(this,function(_,Promise,eventifier,uuid){"use strict";return _=_&&_.hasOwnProperty("default")?_.default:_,
Promise=Promise&&Promise.hasOwnProperty("default")?Promise.default:Promise,eventifier=eventifier&&eventifier.hasOwnProperty("default")?eventifier.default:eventifier,uuid=uuid&&uuid.hasOwnProperty("default")?uuid.default:uuid,function(){function getId(){var id="promise-"+uuid(6);return void 0===queue[id]?id:getId()}var queue={};return{add:function(promise){return queue[getId()]=promise,this},getValues:function(){return _.values(queue)},clear:function(){return queue={},this},serie:function(promiseFn){var id=getId(),currentQueue=this.getValues(),emitter=eventifier();return queue[id]=new Promise(function(resolve){emitter.on("fulfilled",resolve)}),Promise.all(
currentQueue).then(function(){if(_.isFunction(promiseFn))return promiseFn()}).then(function(data){return emitter.trigger("fulfilled"),delete queue[id],data}).catch(function(err){throw queue={},err})}}}}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("core/promise"),require("core/promiseQueue"),require("lib/uuid")):"function"==typeof define&&define.amd?define("core/store/localstorage",["lodash","core/promise","core/promiseQueue","lib/uuid"],factory):(global=global||self)["core/store/localstorage"]=factory(global._,global["core/promise"],global["core/promiseQueue"],
global["lib/uuid"])}(this,function(_,Promise,promiseQueue,uuid){"use strict";_=_&&_.hasOwnProperty("default")?_.default:_,Promise=Promise&&Promise.hasOwnProperty("default")?Promise.default:Promise,promiseQueue=promiseQueue&&promiseQueue.hasOwnProperty("default")?promiseQueue.default:promiseQueue,uuid=uuid&&uuid.hasOwnProperty("default")?uuid.default:uuid;var storage=window.localStorage,writingQueue=promiseQueue(),setEntry=function(storeName,key,value){return new Promise(function(resolve,reject){try{storage.setItem("tao-store-"+storeName+"."+key,JSON.stringify(value)),resolve(!0)}catch(ex){reject(ex)}})},getEntry=function(storeName,key){return new Promise(
function(resolve,reject){var value;try{null===(value=storage.getItem("tao-store-"+storeName+"."+key))?resolve():resolve(JSON.parse(value))}catch(ex){reject(ex)}})},getKnownStores=function(){return getEntry("index","stores")},localStorageBackend=function(storeName){var name,registered=!1,openStore=function(){return registered?Promise.resolve():function(storeName){return getKnownStores().then(function(stores){return(stores=stores||{})[storeName]={name:storeName,lastOpen:Date.now()},setEntry("index","stores",stores)})}(storeName).then(function(){registered=!0})};if(_.isEmpty(storeName)||!_.isString(storeName))throw new TypeError("The store name is required")
;return name="tao-store-"+storeName+".",{getItem:function(key){return writingQueue.serie(function(){return openStore().then(function(){return getEntry(storeName,key)})})},setItem:function(key,value){return writingQueue.serie(function(){return openStore().then(function(){return setEntry(storeName,key,value)})})},removeItem:function(key){return writingQueue.serie(function(){return openStore().then(function(){return storage.removeItem(name+key),!0})})},getItems:function(){var keyPattern=new RegExp("^"+name);return writingQueue.serie(function(){return openStore().then(function(){return _(storage).map(function(entry,index){return storage.key(index)}).filter(
function(key){return keyPattern.test(key)}).reduce(function(acc,key){var value,exposedKey=key.replace(name,"");try{null!==(value=storage.getItem(key))&&(acc[exposedKey]=JSON.parse(value))}catch(ex){acc[exposedKey]=null}return acc},{})})})},clear:function(){var keyPattern=new RegExp("^"+name);return writingQueue.serie(function(){return openStore().then(function(){return _(storage).map(function(entry,index){return storage.key(index)}).filter(function(key){return keyPattern.test(key)}).forEach(function(key){storage.removeItem(key)}),!0})})},removeStore:function(){return this.clear().then(function(){return function(storeName){return getKnownStores().then(
function(stores){return delete(stores=stores||{})[storeName],setEntry("index","stores",stores)})}(storeName)})}}};return localStorageBackend.removeAll=function(validate){return _.isFunction(validate)||(validate=null),getKnownStores().then(function(stores){var removing=_(stores).filter(function(store,storeName){return!validate||validate(storeName,store)}).map(function(store){return store&&store.name?localStorageBackend(store.name).removeStore():Promise.resolve()}).value();return Promise.all(removing)})},localStorageBackend.getAll=function(validate){return getKnownStores().then(function(stores){return _(stores).filter(function(store,storeName){
return!validate||validate(storeName,store)}).map(function(store){return store.name}).value()})},localStorageBackend.getStoreIdentifier=function(){var idStore=localStorageBackend("id");return idStore.getItem("id").then(function(id){return _.isEmpty(id)?(id=uuid(),idStore.setItem("id",id).then(function(){return id})):id})},localStorageBackend}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("core/promise"),require("lib/store/idbstore"),require("lib/uuid")):"function"==typeof define&&define.amd?define("core/store/indexeddb",["lodash","core/promise","lib/store/idbstore","lib/uuid"],
factory):(global=global||self)["core/store/indexeddb"]=factory(global._,global["core/promise"],global["lib/store/idbstore"],global["lib/uuid"])}(this,function(_,Promise,IDBStore,uuid){"use strict";_=_&&_.hasOwnProperty("default")?_.default:_,Promise=Promise&&Promise.hasOwnProperty("default")?Promise.default:Promise,IDBStore=IDBStore&&IDBStore.hasOwnProperty("default")?IDBStore.default:IDBStore,uuid=uuid&&uuid.hasOwnProperty("default")?uuid.default:uuid;var knownStores,isIndexedDB2="getAll"in IDBObjectStore.prototype,openStore=function(storeName){return new Promise(function(resolve,reject){var store=new IDBStore({dbVersion:1,storeName:storeName,
storePrefix:"tao-store-",keyPath:"key",autoIncrement:!0,onStoreReady:function(){store.db.onversionchange=function(e){e&&e.newVersion||store.db.close()},resolve(store)},onError:reject})})},setEntry=function(store,key,value){return new Promise(function(resolve,reject){var entry={key:key,value:value};store.put(entry,function(returnKey){resolve(returnKey===key)},reject)})},getEntry=function(store,key){return new Promise(function(resolve,reject){store.get(key,function(entry){if(!entry||void 0===entry.value)return resolve(entry);resolve(entry.value)},reject)})},removeEntry=function(store,key){return new Promise(function(resolve,reject){store.remove(key,function(
result){resolve(!1!==result)},reject)})},getKnownStores=function(){return knownStores=knownStores||openStore("index")},deleteStore=function(store,storeName){return new Promise(function(resolve,reject){var success=function(){(function(storeName){return getKnownStores().then(function(store){return removeEntry(store,storeName)})})(storeName).then(function(){resolve(!0)}).catch(reject)};isIndexedDB2?store.deleteDatabase(success,reject):store.clear(success,reject)})},indexDbBackend=function(storeName){var innerStore,writePromise,getStore=function(){return innerStore=innerStore||openStore(storeName).then(function(store){return function(storeName){
return getKnownStores().then(function(store){return setEntry(store,storeName,{name:storeName,lastOpen:Date.now()})})}(storeName).then(function(){return Promise.resolve(store)})})},ensureSerie=function(getWritingPromise){return writePromise?new Promise(function(resolve,reject){function runWrite(){var p=getWritingPromise();(writePromise=p).then(resolve).catch(reject)}writePromise.then(runWrite).catch(runWrite)}):writePromise=getWritingPromise()};if(_.isEmpty(storeName)||!_.isString(storeName))throw new TypeError("The store name is required");return{getItem:function(key){return ensureSerie(function(){return getStore().then(function(store){return getEntry(store,
key)})})},setItem:function(key,value){return ensureSerie(function(){return getStore().then(function(store){return setEntry(store,key,value)})})},removeItem:function(key){return ensureSerie(function(){return getStore().then(function(store){return removeEntry(store,key)})})},getItems:function(){return ensureSerie(function(){return getStore().then(function(store){return function(store){return new Promise(function(resolve,reject){store.getAll(function(entries){if(!_.isArray(entries))return resolve({});resolve(_.reduce(entries,function(acc,entry){return entry.key&&entry.value&&(acc[entry.key]=entry.value),acc},{}))},reject)})}(store)})})},clear:function(){
return ensureSerie(function(){return getStore().then(function(store){return new Promise(function(resolve,reject){store.clear(function(){resolve(!0)},reject)})})})},removeStore:function(){return ensureSerie(function(){return getStore().then(function(store){return deleteStore(store,storeName)})})}}};return indexDbBackend.removeAll=function(validate){return _.isFunction(validate)||(validate=null),getKnownStores().then(function(store){return new Promise(function(resolve,reject){store.getAll(function(entries){var all=[];_.forEach(entries,function(entry){var storeName=entry&&entry.key;storeName&&all.push(openStore(storeName).then(function(storeToRemove){if(
!validate||validate(storeName,entry.value))return deleteStore(storeToRemove,storeName)}))}),Promise.all(all).then(resolve).catch(reject)},reject)})})},indexDbBackend.getAll=function(validate){return _.isFunction(validate)||(validate=function(){return!0}),getKnownStores().then(function(store){return new Promise(function(resolve,reject){store.getAll(function(entries){var storeNames=_(entries).filter(function(entry){return entry&&entry.key&&validate(entry.key,entry.value)}).map(function(entry){return entry.key}).value();return resolve(storeNames)},reject)})})},indexDbBackend.getStoreIdentifier=function(){return openStore("id").then(function(store){
return getEntry(store,"id").then(function(id){return _.isEmpty(id)?(id=uuid(),setEntry(store,"id",id).then(function(){return id})):id})})},indexDbBackend}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("core/promise"),require("lib/uuid")):"function"==typeof define&&define.amd?define("core/store/memory",["lodash","core/promise","lib/uuid"],factory):(global=global||self)["core/store/memory"]=factory(global._,global["core/promise"],global["lib/uuid"])}(this,function(_,Promise,uuid){"use strict";_=_&&_.hasOwnProperty("default")?_.default:_,Promise=Promise&&Promise.hasOwnProperty(
"default")?Promise.default:Promise,uuid=uuid&&uuid.hasOwnProperty("default")?uuid.default:uuid;var idStore,memoryStore={},memoryStorageBackend=function(storeName){if(_.isEmpty(storeName)||!_.isString(storeName))throw new TypeError("The store name is required");return memoryStore[storeName]=memoryStore[storeName]||{},{getItem:function(key){return _.isPlainObject(memoryStore[storeName])?Promise.resolve(memoryStore[storeName][key]):Promise.resolve()},setItem:function(key,value){return _.isPlainObject(memoryStore[storeName])||(memoryStore[storeName]={}),memoryStore[storeName][key]=value,Promise.resolve(!0)},removeItem:function(key){
return memoryStore[storeName]=_.omit(memoryStore[storeName],key),Promise.resolve(void 0===memoryStore[storeName][key])},getItems:function(){return Promise.resolve(memoryStore[storeName])},clear:function(){return memoryStore[storeName]={},Promise.resolve(!0)},removeStore:function(){return memoryStore=_.omit(memoryStore,storeName),Promise.resolve(void 0===memoryStore[storeName])}}};return memoryStorageBackend.removeAll=function(validate){return _.isFunction(validate)||(validate=null),memoryStore=_.omit(memoryStore,function(store,storeName){return!validate||validate(storeName)}),Promise.resolve(!0)},memoryStorageBackend.getAll=function(validate){var storeNames
;return _.isFunction(validate)||(validate=null),storeNames=_(memoryStore).map(function(store,storeName){return storeName}).filter(function(storeName){return!validate||validate(storeName)}).value(),Promise.resolve(storeNames)},memoryStorageBackend.getStoreIdentifier=function(){return _.isEmpty(idStore)&&(idStore=uuid()),Promise.resolve(idStore)},memoryStorageBackend}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("moment"),require("module"),require("core/logger"),require("core/promise"),require("core/store/localstorage"),require("core/store/indexeddb"),require("core/store/memory"
)):"function"==typeof define&&define.amd?define("core/store",["lodash","moment","module","core/logger","core/promise","core/store/localstorage","core/store/indexeddb","core/store/memory"],factory):(global=global||self)["core/store"]=factory(global._,global.moment,global.module,global["core/logger"],global["core/promise"],global["core/store/localstorage"],global["core/store/indexeddb"],global["core/store/memory"])}(this,function(_,moment,module,loggerFactory,Promise,localStorageBackend,indexedDBBackend,memoryBackend){"use strict";_=_&&_.hasOwnProperty("default")?_.default:_,moment=moment&&moment.hasOwnProperty("default")?moment.default:moment,
module=module&&module.hasOwnProperty("default")?module.default:module,loggerFactory=loggerFactory&&loggerFactory.hasOwnProperty("default")?loggerFactory.default:loggerFactory,Promise=Promise&&Promise.hasOwnProperty("default")?Promise.default:Promise,localStorageBackend=localStorageBackend&&localStorageBackend.hasOwnProperty("default")?localStorageBackend.default:localStorageBackend,indexedDBBackend=indexedDBBackend&&indexedDBBackend.hasOwnProperty("default")?indexedDBBackend.default:indexedDBBackend,memoryBackend=memoryBackend&&memoryBackend.hasOwnProperty("default")?memoryBackend.default:memoryBackend;var store,supportsIndexedDB=!1,dectectionDone=!1,
quotaChecked=!1,backendApi=["removeAll","getAll","getStoreIdentifier"],storeApi=["getItem","setItem","removeItem","getItems","clear","removeStore"],logger=loggerFactory("core/store"),config=_.defaults(module.config()||{},{lowSpaceRatio:80,invalidation:{staled:"P2W",oldster:"P2M"}}),isIndexDBSupported=function(){return dectectionDone?Promise.resolve(supportsIndexedDB):new Promise(function(resolve){var test,indexedDB,done=function(result){return dectectionDone=!0,resolve(supportsIndexedDB=!!result)};try{if(!(indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.OIndexedDB||window.msIndexedDB))return done(!1);(test=indexedDB.open(
"__feature_test",1)).onsuccess=function(){if(test.result)return test.result.close(),done(!0)},test.onerror=function(e){return e.preventDefault(),done(!1),!1}}catch(err){done(!1)}})},loadBackend=function(preselectedBackend){return isIndexDBSupported().then(function(){var backend=preselectedBackend||(supportsIndexedDB?indexedDBBackend:localStorageBackend);return _.isFunction(backend)?function(backend){return _.all(backendApi,function(method){return _.isFunction(backend[method])})}(backend)?(backend!==memoryBackend&&(!quotaChecked&&"storage"in window.navigator&&window.navigator.storage.estimate&&window.navigator.storage.estimate().then(function(estimate){
var usedRatio=0;_.isNumber(estimate.usage)&&_.isNumber(estimate.quota)&&0<estimate.quota&&((usedRatio=estimate.usage/estimate.quota)>config.lowSpaceRatio?(logger.warn("The browser storage is getting low "+usedRatio.toFixed(2)+"% used",estimate),logger.warn("We will attempt to clean oldster databases in persistent backends"),store.cleanUpSpace(config.invalidation.oldster,[],localStorageBackend),store.cleanUpSpace(config.invalidation.oldster,[],indexedDBBackend)):logger.debug("Browser storage estimate : "+usedRatio.toFixed(2)+"% used",estimate))}).catch(function(err){logger.warn("Unable to retrieve quotas : "+err.message)}),quotaChecked=!0),backend
):Promise.reject(new TypeError("This backend doesn't comply with the store backend API")):Promise.reject(new TypeError("No backend, no storage!"))})};return(store=function(storeName,preselectedBackend){return loadBackend(preselectedBackend).then(function(backend){var storeInstance=backend(storeName);return function(storage){return _.all(storeApi,function(method){return _.isFunction(storage[method])})}(storeInstance)?storeInstance:Promise.reject(new TypeError("The store doesn't comply with the Storage interface"))})}).backends={localStorage:localStorageBackend,indexedDB:indexedDBBackend,memory:memoryBackend},store.removeAll=function(validate,
preselectedBackend){return loadBackend(preselectedBackend).then(function(backend){return backend.removeAll(validate)})},store.cleanUpSpace=function(since,storeNamePattern,preselectedBackend){var tsThreshold;return tsThreshold=_.isNumber(since)&&0<since?since:(_.isString(since)||(since=config.invalidation.oldster),moment().subtract(moment.duration(since)).valueOf()),logger.info("Trying to remove stores lastly opened before "+tsThreshold+"("+since+")"),store.removeAll(function(storeName,storeEntry){return!(!storeName||!storeEntry)&&(!(storeNamePattern instanceof RegExp&&!storeNamePattern.test(storeName))&&(_.isNumber(storeEntry.lastOpen)&&_.isNumber(
tsThreshold)&&storeEntry.lastOpen<=tsThreshold))},preselectedBackend)},store.getAll=function(validate,preselectedBackend){return loadBackend(preselectedBackend).then(function(backend){return backend.getAll(validate)})},store.getIdentifier=function(preselectedBackend){return loadBackend(preselectedBackend).then(function(backend){return backend.getStoreIdentifier()})},store}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("core/promise"),require("core/store")):"function"==typeof define&&define.amd?define("core/tokenStore",["lodash","core/promise","core/store"],factory):(
global=global||self)["core/tokenStore"]=factory(global._,global["core/promise"],global["core/store"])}(this,function(_,Promise,store){"use strict";_=_&&_.hasOwnProperty("default")?_.default:_,Promise=Promise&&Promise.hasOwnProperty("default")?Promise.default:Promise,store=store&&store.hasOwnProperty("default")?store.default:store;var defaultConfig={maxSize:6,tokenTimeLimit:144e4};return function(options){var config=_.defaults(options||{},defaultConfig),getStore=function(){return store("tokenStore.tokens",store.backends.memory)};return{dequeue:function(){var self=this;return self.getIndex().then(function(latestIndex){var key=_.first(latestIndex)
;return key?getStore().then(function(storage){return storage.getItem(key)}).then(function(token){return self.remove(key).then(function(){return token})}):Promise.resolve()})},enqueue:function(token){var self=this;return _.isString(token)&&(token={value:token,receivedAt:Date.now()}),getStore().then(function(storage){return storage.setItem(token.value,token)}).then(function(updated){return!!updated&&self.enforceMaxSize().then(function(){return!0})})},getIndex:function(){return this.getTokens().then(function(tokens){return _.chain(tokens).values().sort(function(t1,t2){return t1.receivedAt-t2.receivedAt}).map("value").value()})},has:function(key){
return this.getIndex().then(function(latestIndex){return _.contains(latestIndex,key)})},remove:function(key){return this.has(key).then(function(result){return!!result&&getStore().then(function(storage){return storage.removeItem(key)})})},clear:function(){return getStore().then(function(storage){return storage.clear()})},getTokens:function(){return getStore().then(function(storage){return storage.getItems()})},getSize:function(){return this.getIndex().then(function(latestIndex){return latestIndex.length})},setMaxSize:function(size){_.isNumber(size)&&0<size&&size!==config.maxSize&&(config.maxSize=size,this.enforceMaxSize())},enforceMaxSize:function(){
var self=this;return this.getIndex().then(function(latestIndex){var keysToRemove,excess=latestIndex.length-config.maxSize;return!(0<excess)||(keysToRemove=latestIndex.slice(0,excess),Promise.all(_.map(keysToRemove,function(key){return self.remove(key)})))})},checkExpiry:function(token){return!(Date.now()-token.receivedAt>config.tokenTimeLimit)||this.remove(token.value)},expireOldTokens:function(){var self=this;return self.getTokens().then(function(tokens){return _.reduce(tokens,function(previousPromise,nextToken){return previousPromise.then(function(){return self.checkExpiry(nextToken)})},Promise.resolve()).then(function(){return!0})})}}}}),function(global,
factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("module"),require("core/tokenStore"),require("core/promise"),require("core/promiseQueue")):"function"==typeof define&&define.amd?define("core/tokenHandler",["lodash","module","core/tokenStore","core/promise","core/promiseQueue"],factory):(global=global||self)["core/tokenHandler"]=factory(global._,global.module,global["core/tokenStore"],global["core/promise"],global["core/promiseQueue"])}(this,function(_,module,tokenStoreFactory,Promise,promiseQueue){"use strict";_=_&&_.hasOwnProperty("default")?_.default:_,module=module&&module.hasOwnProperty(
"default")?module.default:module,tokenStoreFactory=tokenStoreFactory&&tokenStoreFactory.hasOwnProperty("default")?tokenStoreFactory.default:tokenStoreFactory,Promise=Promise&&Promise.hasOwnProperty("default")?Promise.default:Promise,promiseQueue=promiseQueue&&promiseQueue.hasOwnProperty("default")?promiseQueue.default:promiseQueue;var clientConfigFetched=!1,defaults={maxSize:6,tokenTimeLimit:144e4};return function(options){var tokenStore;return _.isString(options)&&(options={initialToken:options}),options=_.defaults({},options,defaults),tokenStore=tokenStoreFactory(options),{getToken:function(){var self=this,initialToken=options.initialToken,
getFirstTokenValue=function(){return tokenStore.dequeue().then(function(currentToken){return currentToken?currentToken.value:null})};return initialToken?(options.initialToken=null,Promise.resolve(initialToken)):tokenStore.expireOldTokens().then(function(){return tokenStore.getSize()}).then(function(queueSize){return 0<queueSize?getFirstTokenValue():clientConfigFetched?Promise.reject(new Error("No tokens available. Please refresh the page.")):self.getClientConfigTokens().then(getFirstTokenValue)})},setToken:function(newToken){return tokenStore.enqueue(newToken)},getClientConfigTokens:function(){var self=this,clientTokens=_.map(module.config().tokens,function(
serverToken){return{value:serverToken,receivedAt:Date.now()}});return clientConfigFetched=!0,Promise.resolve(clientTokens).then(function(newTokens){var setTokenQueue=promiseQueue();return _.forEach(newTokens,function(token){setTokenQueue.serie(function(){return self.setToken(token)})}),setTokenQueue.serie(function(){return!0})})},clearStore:function(){return tokenStore.clear()},getQueueLength:function(){return tokenStore.getSize()},setMaxSize:function(size){tokenStore.setMaxSize(size)}}}}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("jquery"),require("lodash"),require("i18n"),require("module"),
require("context"),require("core/promise"),require("core/promiseQueue"),require("core/tokenHandler"),require("core/logger")):"function"==typeof define&&define.amd?define("core/request",["jquery","lodash","i18n","module","context","core/promise","core/promiseQueue","core/tokenHandler","core/logger"],factory):(global=global||self)["core/request"]=factory(global.$,global._,global.__,global.module,global.context,global["core/promise"],global["core/promiseQueue"],global["core/tokenHandler"],global["core/logger"])}(this,function($,_,__,module,context,Promise,promiseQueue,tokenHandlerFactory,loggerFactory){"use strict";$=$&&$.hasOwnProperty("default")?$.default:$,
_=_&&_.hasOwnProperty("default")?_.default:_,__=__&&__.hasOwnProperty("default")?__.default:__,module=module&&module.hasOwnProperty("default")?module.default:module,context=context&&context.hasOwnProperty("default")?context.default:context,Promise=Promise&&Promise.hasOwnProperty("default")?Promise.default:Promise,promiseQueue=promiseQueue&&promiseQueue.hasOwnProperty("default")?promiseQueue.default:promiseQueue,tokenHandlerFactory=tokenHandlerFactory&&tokenHandlerFactory.hasOwnProperty("default")?tokenHandlerFactory.default:tokenHandlerFactory,loggerFactory=loggerFactory&&loggerFactory.hasOwnProperty("default")?loggerFactory.default:loggerFactory
;var tokenHandler=tokenHandlerFactory(),queue=promiseQueue(),logger=loggerFactory("core/request"),createError=function(response,fallbackMessage,httpCode,httpSent){var err;return(err=response&&response.errorCode?new Error(response.errorCode+" : "+(response.errorMsg||response.errorMessage||response.error)):new Error(fallbackMessage)).response=response,err.sent=httpSent,httpCode&&(err.code=httpCode),err};return function(options){if(module.config().noToken&&(options.noToken=!0),_.isEmpty(options.url))throw new TypeError("At least give a URL...");function runRequest(){var headers,setTokenFromXhr=function(xhr){var token;return _.isFunction(xhr.getResponseHeader
)&&(token=xhr.getResponseHeader("X-CSRF-Token"),logger.debug("received %s header %s","X-CSRF-Token",token),token)?tokenHandler.setToken(token):Promise.resolve()};return(headers=_.extend({},options.headers),options.noToken?Promise.resolve(headers):tokenHandler.getToken().then(function(token){return headers["X-CSRF-Token"]=token||"none",headers})).then(function(customHeaders){return new Promise(function(resolve,reject){$.ajax({url:options.url,method:options.method||"GET",headers:customHeaders,data:options.data,contentType:options.contentType||void 0,dataType:options.dataType||"json",async:!0,timeout:1e3*options.timeout||1e3*context.timeout||0,
beforeSend:function(){_.isEmpty(customHeaders)||logger.debug("sending %s header %s","X-CSRF-Token",customHeaders&&customHeaders["X-CSRF-Token"])},global:!options.background}).done(function(response,status,xhr){setTokenFromXhr(xhr).then(function(){return 204===xhr.status||response&&204===response.errorCode||"nocontent"===status?resolve():403===xhr.status||response&&403===response.errorCode?reject(createError(response,xhr.status+" : "+xhr.statusText,xhr.status,0<xhr.readyState)):200===xhr.status||response&&!0===response.success?resolve(response):void reject(createError(response,__("The server has sent an empty response"),xhr.status,0<xhr.readyState))}).catch(
function(error){logger.error(error),reject(createError(response,error,xhr.status,0<xhr.readyState))})}).fail(function(xhr,textStatus,errorThrown){var response;try{response=JSON.parse(xhr.responseText)}catch(parseErr){response=xhr.responseText}response=_.defaults(response,{success:!1,source:"network",cause:options.url,purpose:"proxy",context:this,code:xhr.status,sent:0<xhr.readyState,type:"error",message:errorThrown||__("An error occurred!")}),setTokenFromXhr(xhr).then(function(){reject(createError(response,xhr.status+" : "+xhr.statusText,xhr.status,0<xhr.readyState))}).catch(function(error){logger.error(error),reject(createError(response,error,xhr.status,
0<xhr.readyState))})})})})}return tokenHandler.getQueueLength().then(function(queueLength){return!0===options.noToken?runRequest():options.sequential||1===queueLength?queue.serie(runRequest):runRequest()})}}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("core/request")):"function"==typeof define&&define.amd?define("core/dataProvider/request",["lodash","core/request"],factory):(global=global||self)["core/dataProvider/request"]=factory(global._,global["core/request"])}(this,function(_,coreRequest){"use strict";return _=_&&_.hasOwnProperty("default")?_.default:_,
coreRequest=coreRequest&&coreRequest.hasOwnProperty("default")?coreRequest.default:coreRequest,function(url,data,method,headers,background,noToken){return coreRequest({url:url,data:data,method:method,headers:headers,background:background,noToken:!1!==noToken}).then(function(response){return _.isUndefined(response)?Promise.resolve():response.success?Promise.resolve(response.data):Promise.reject(response)}).catch(function(error){return Promise.reject(error)})}}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("lodash")):"function"==typeof define&&define.amd?define("util/namespace",["lodash"],factory
):(global=global||self)["util/namespace"]=factory(global._)}(this,function(_){"use strict";_=_&&_.hasOwnProperty("default")?_.default:_;var reSplit=/\s/g,namespaceHelper={split:function(names,normalize){return!_.isString(names)||_.isEmpty(names)?[]:(normalize&&(names=names.toLowerCase()),_(names.trim().split(reSplit)).compact().uniq().value())},getName:function(namespaced){return!_.isString(namespaced)||_.isEmpty(namespaced)?"":-1<namespaced.indexOf(".")?namespaced.substr(0,namespaced.indexOf(".")):namespaced},getNamespace:function(namespaced,defaultNs){return!_.isString(namespaced)||_.isEmpty(namespaced)?"":-1<namespaced.indexOf(".")?namespaced.substr(
namespaced.indexOf(".")+1):defaultNs||"@"},namespaceAll:function(names,namespace,normalize){var suffix;return _.isArray(names)||(names=namespaceHelper.split(names,normalize)),normalize&&(namespace=namespace.toLowerCase()),suffix=namespace?"."+namespace:"",_(names).map(function(sh){return sh.indexOf(".")<0?sh+suffix:sh}).compact().uniq().value().join(" ")}};return namespaceHelper}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("jquery"),require("lodash"),require("util/namespace")):"function"==typeof define&&define.amd?define("util/shortcut/registry",["jquery","lodash","util/namespace"],factory):(
global=global||self)["util/shortcut/registry"]=factory(global.$,global._,global["util/namespace"])}(this,function($,_,namespaceHelper){"use strict";$=$&&$.hasOwnProperty("default")?$.default:$,_=_&&_.hasOwnProperty("default")?_.default:_,namespaceHelper=namespaceHelper&&namespaceHelper.hasOwnProperty("default")?namespaceHelper.default:namespaceHelper;var modifiers={ctrl:"ctrlKey",alt:"altKey",option:"altKey",shift:"shiftKey",meta:"metaKey",cmd:"metaKey",win:"metaKey"},translateKeys={escape:"esc",arrowdown:"down",arrowleft:"left",arrowright:"right",arrowup:"up"},specialKeys={8:"backspace",9:"tab",13:"enter",19:"pause",20:"capslock",27:"esc",32:"space",
33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",91:"meta",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",145:"scrolllock",144:"numlock"};function registerEvent(target,eventName,listener){target.addEventListener?target.addEventListener(eventName,listener,!1):target.attachEvent?target.attachEvent("on"+eventName,listener):target["on"+eventName]=listener}function unregisterEvent(target,eventName,listener){target.removeEventListener?target.removeEventListener(eventName,listener,!1):target.detachEvent?target.detachEvent("on"+eventName,
listener):target["on"+eventName]=null}function normalizeCommand(descriptor){var key=translateKeys[descriptor.key]||descriptor.key,parts=[];return descriptor.ctrlKey&&parts.push("control"),descriptor.altKey&&parts.push("alt"),descriptor.shiftKey&&parts.push("shift"),descriptor.metaKey&&parts.push("meta"),descriptor.scrollDown&&parts.push("scrollDown"),descriptor.scrollUp&&parts.push("scrollUp"),descriptor.clickLeft&&parts.push("clickLeft"),descriptor.clickRight&&parts.push("clickRight"),descriptor.clickMiddle&&parts.push("clickMiddle"),descriptor.clickBack&&parts.push("clickBack"),descriptor.clickForward&&parts.push("clickForward"),key&&parts.indexOf(key
)<0&&parts.push(key),parts.join("+")}function parseCommand(shortcut){var parts=namespaceHelper.getName(shortcut).split("+"),descriptor={keyboardInvolved:!1,mouseClickInvolved:!1,mouseWheelInvolved:!1,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,key:null,scrollUp:null,scrollDown:null,clickLeft:null,clickRight:null,clickMiddle:null,clickBack:null,clickForward:null};return _.forEach(parts,function(part){if(modifiers[part])descriptor[modifiers[part]]=!0;else if(0<=part.indexOf("mouse")){if(descriptor.keyboardInvolved)throw new Error("A shortcut cannot involve both mouse and regular keys!");0<=part.indexOf("scroll")&&(descriptor.mouseWheelInvolved=!0,
descriptor.scrollUp=0<=part.indexOf("up"),descriptor.scrollDown=0<=part.indexOf("down")),0<=part.indexOf("click")&&(descriptor.mouseClickInvolved=!0,descriptor.clickLeft=0<=part.indexOf("left"),descriptor.clickRight=0<=part.indexOf("right"),descriptor.clickMiddle=0<=part.indexOf("middle"),descriptor.clickBack=0<=part.indexOf("back"),descriptor.clickForward=0<=part.indexOf("forward"))}else{if(descriptor.mouseClickInvolved||descriptor.mouseWheelInvolved)throw new Error("A shortcut cannot involve both mouse and regular keys!");descriptor.keyboardInvolved=!0,descriptor.key=part}}),descriptor}return function(root,defaultOptions){var keyboardIsRegistered=!1,
mouseClickIsRegistered=!1,mouseWheelIsRegistered=!1,keyboardCount=0,mouseClickCount=0,mouseWheelCount=0,shortcuts={},handlers={},states={};function getHandlers(command,namespace){return handlers[namespace]=handlers[namespace]||{},handlers[namespace][command]=handlers[namespace][command]||[],handlers[namespace][command]}function getCommandHandlers(command){return _.reduce(handlers,function(acc,nsHandlers){return nsHandlers[command]&&(acc=acc.concat(nsHandlers[command])),acc},[])}function setOptions(descriptor,options){descriptor.options=_.defaults(_.merge(descriptor.options||{},options),defaultOptions)}function unregisterKeyboard(){--keyboardCount<=0&&(
keyboardCount=0,keyboardIsRegistered&&(unregisterEvent(root,"keydown",onKeyboard),keyboardIsRegistered=!1))}function unregisterMouseClick(){--mouseClickCount<=0&&(mouseClickCount=0,mouseClickIsRegistered&&(unregisterEvent(root,"click",onMouseClick),mouseClickIsRegistered=!1))}function unregisterMouseWheel(){--mouseWheelCount<=0&&(mouseWheelCount=0,mouseWheelIsRegistered&&(unregisterEvent(root,"wheel",onMouseWheel),mouseWheelIsRegistered=!1))}function registerCommand(command,descriptor){(shortcuts[command]=descriptor).keyboardInvolved&&(keyboardIsRegistered||(registerEvent(root,"keydown",onKeyboard),keyboardIsRegistered=!0),keyboardCount++),
descriptor.mouseClickInvolved&&(mouseClickIsRegistered||(registerEvent(root,"click",onMouseClick),mouseClickIsRegistered=!0),mouseClickCount++),descriptor.mouseWheelInvolved&&(mouseWheelIsRegistered||(registerEvent(root,"wheel",onMouseWheel),mouseWheelIsRegistered=!0),mouseWheelCount++)}function onKeyboard(event){processShortcut(event,{keyboardInvolved:!0,ctrlKey:event.ctrlKey,altKey:event.altKey,shiftKey:event.shiftKey,metaKey:event.metaKey,key:function(event){var code=event.which||event.keyCode,character=32<=code?String.fromCharCode(code).toLowerCase():"",key=event.key&&event.key.toLowerCase(),keyName=event.code&&event.code.toLowerCase();return keyName&&(
0===keyName.indexOf("key")?(key<"a"||"z"<key)&&"a"<=character&&character<="z"&&(key=character):0===keyName.indexOf("digit")&&(key=keyName.substr(5))),specialKeys[code]||key||character}(event)})}function onMouseClick(event){processShortcut(event,_.merge({mouseClickInvolved:!0,ctrlKey:event.ctrlKey,altKey:event.altKey,shiftKey:event.shiftKey,metaKey:event.metaKey},function(event){var buttons={clickLeft:!1,clickRight:!1,clickMiddle:!1,clickBack:!1,clickForward:!1};if(event.buttons)buttons.clickLeft=!!(1&event.buttons),buttons.clickRight=!!(2&event.buttons),buttons.clickMiddle=!!(4&event.buttons),buttons.clickBack=!!(8&event.buttons),buttons.clickForward=!!(
16&event.buttons);else switch(event.button){case 0:buttons.clickLeft=!0;break;case 1:buttons.clickMiddle=!0;break;case 2:buttons.clickRight=!0;break;case 3:buttons.clickBack=!0;break;case 4:buttons.clickForward=!0}return buttons}(event)))}function onMouseWheel(event){processShortcut(event,_.merge({mouseClickInvolved:!0,ctrlKey:event.ctrlKey,altKey:event.altKey,shiftKey:event.shiftKey,metaKey:event.metaKey},function(event){return{scrollUp:event.deltaY<0,scrollDown:0<event.deltaY}}(event)))}function processShortcut(event,descriptor){var shortcutHandlers,$target,command=normalizeCommand(descriptor),shortcut=shortcuts[command];if(shortcut&&!states.disabled){if(
!0===shortcut.options.avoidInput&&($target=$(event.target)).closest('[type="text"],textarea').length&&(!shortcut.options.allowIn||!$target.closest(shortcut.options.allowIn).length))return;!1===shortcut.options.propagate&&event.stopPropagation(),!0===shortcut.options.prevent&&event.preventDefault(),(shortcutHandlers=getCommandHandlers(command))&&_.forEach(shortcutHandlers,function(handler){handler(event,command)})}}return root.jquery&&(root=root.get(0)),{set:function(shortcut,options){return _.forEach(namespaceHelper.split(shortcut,!0),function(normalized){var descriptor=parseCommand(normalized),command=normalizeCommand(descriptor);setOptions(descriptor,
options),registerCommand(command,descriptor)}),this},add:function(shortcut,handler,options){return _.isFunction(handler)&&_.forEach(namespaceHelper.split(shortcut,!0),function(normalized){var namespace=namespaceHelper.getNamespace(normalized,"*"),descriptor=parseCommand(normalized),command=normalizeCommand(descriptor);setOptions(descriptor,options),registerCommand(command,descriptor),getHandlers(command,namespace).push(handler)}),this},remove:function(shortcut){return _.forEach(namespaceHelper.split(shortcut,!0),function(normalized){var namespace=namespaceHelper.getNamespace(normalized,"*"),command=normalizeCommand(parseCommand(normalized));!function(command
,namespace){namespace&&!command?handlers[namespace]={}:_.forEach(handlers,function(nsHandlers,ns){!nsHandlers[command]||"*"!==namespace&&namespace!==ns||(nsHandlers[command]=[])})}(command,namespace),getCommandHandlers(command).length||function(command){var descriptor=shortcuts[command];shortcuts[command]=null,descriptor&&(descriptor.keyboardInvolved&&unregisterKeyboard(),descriptor.mouseClickInvolved&&unregisterMouseClick(),descriptor.mouseWheelInvolved&&unregisterMouseWheel())}(command)}),this},exists:function(shortcut){var normalized=String(shortcut).trim().toLowerCase(),namespace=namespaceHelper.getNamespace(normalized,"*"),command=normalizeCommand(
parseCommand(normalized)),shortcutExists=!1;return shortcuts[command]?shortcutExists="*"===namespace||!!getHandlers(command,namespace).length:command||(shortcutExists=!_.isEmpty(handlers[namespace])),shortcutExists},clear:function(){return shortcuts={},handlers={},mouseWheelCount=mouseClickCount=keyboardCount=0,unregisterKeyboard(),unregisterMouseClick(),unregisterMouseWheel(),this},getState:function(name){return!!states[name]},setState:function(name,state){return states[name]=!!state,this},enable:function(){return this.setState("disabled",!1),this},disable:function(){return this.setState("disabled",!0),this}}}}),function(global,factory){
"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("jquery"),require("lodash")):"function"==typeof define&&define.amd?define("core/pluginifier",["jquery","lodash"],factory):(global=global||self)["core/pluginifier"]=factory(global.$,global._)}(this,function($,_){"use strict";$=$&&$.hasOwnProperty("default")?$.default:$,_=_&&_.hasOwnProperty("default")?_.default:_;var basePlugin={options:function(dataNs,ns,options){return this.each(function(){var $elt=$(this),currentOptions=$elt.data(dataNs);currentOptions&&$elt.data(dataNs,_.merge(currentOptions,options))})},disable:function(dataNs,ns){return this.each(function(){var $elt=$(
this),options=$elt.data(dataNs);options&&$elt.addClass(options.disableClass||"disabled").trigger("disable."+ns)})},enable:function(dataNs,ns){return this.each(function(){var $elt=$(this),options=$elt.data(dataNs);options&&$elt.removeClass(options.disableClass||"disabled").trigger("enable."+ns)})}};return{register:function(pluginName,plugin,config){var ns=(config=config||{}).ns||pluginName.toLowerCase(),dataNs=config.dataNs||"ui."+ns,expose=config.expose||[];return _.isFunction($.fn[pluginName])?$.error("A plugin named "+pluginName+" is already registered"):_.isPlainObject(plugin)&&_.isFunction(plugin.init)?(_.assign(plugin,_.transform(basePlugin,function(
result,prop,key){_.isFunction(prop)&&(result[key]=_.partial(basePlugin[key],dataNs,ns))})),_.forEach(expose,function(toExposeName){var privateMethod=toExposeName,publicMethod=toExposeName;/^_/.test(expose)?publicMethod=publicMethod.replace(/^_/,""):privateMethod="_"+privateMethod,_.isFunction(plugin[privateMethod])&&!_.isFunction(plugin[publicMethod])&&(plugin[publicMethod]=function(){var returnValue,args=Array.prototype.slice.call(arguments,0);return this.each(function(){returnValue=plugin[privateMethod].apply(plugin,[$(this)].concat(args))}),returnValue||this})}),void($.fn[pluginName]=function(method){if(plugin[method]){if(!/^_/.test(method)
)return plugin[method].apply(this,Array.prototype.slice.call(arguments,1));$.error("Trying to call a private method `"+method+"`")}else if("object"==typeof method||!method)return plugin.init.apply(this,arguments);$.error("Method "+method+" does not exist on plugin")})):$.error("The object to register as a jQuery plugin must be a plain object with an `init` method.")}}}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("jquery"),require("lodash")):"function"==typeof define&&define.amd?define("core/dataattrhandler",["jquery","lodash"],factory):(global=global||self)["core/dataattrhandler"]=factory(
global.$,global._)}(this,function($,_){"use strict";$=$&&$.hasOwnProperty("default")?$.default:$,_=_&&_.hasOwnProperty("default")?_.default:_;var defaults={container:!1,listenerEvent:"click",useTarget:!0,bubbled:!1},letDefaultOn=[":radio",":checkbox"],shouldPreventDefault=function($elt){return!$elt.is(letDefaultOn.join(","))},DataAttrHandler=function(attrName,options){var self=this;this.options=_.defaults(options,defaults);var selector="[data-"+attrName+"]";if(!_.has(this.options,"namespace")||!_.isString(this.options.namespace))return $.error("The plugin data namespace option is required");this.options.container&&this.options.container.selector&&(
selector=this.options.container.selector+" "+selector),this.options.inner&&(selector+=" "+this.options.inner),$(document).off(this.options.listenerEvent,selector).on(this.options.listenerEvent,selector,function(e){var $target,$outer,$elt=$(e.target);!0!==self.options.bubbled&&!$elt.is(selector)||(void 0===$elt.data(attrName)&&(self.options.inner||self.options.bubbled)&&($elt=($outer=$elt).parents("[data-"+attrName+"]")),$target=!0===self.options.useTarget?DataAttrHandler.getTarget(attrName,$elt):self.options.inner?$outer:void 0,$elt.data(self.options.namespace)||("function"==typeof self.createPlugin&&self.createPlugin($elt,$target),$elt.is(":radio"
)&&$elt.attr("name")&&$(':radio[name="'+$elt.attr("name")+'"]').not($elt).on(self.options.listenerEvent,function(e){"function"==typeof self.callPluginMethod&&self.callPluginMethod($elt,$target),shouldPreventDefault($elt)&&e.preventDefault()})),"function"==typeof self.callPluginMethod&&self.callPluginMethod($elt,$target),shouldPreventDefault($elt)&&e.preventDefault())})};return DataAttrHandler.prototype.init=function(cb){return this.createPlugin=cb,this},DataAttrHandler.prototype.trigger=function(cb){return this.callPluginMethod=cb,this},DataAttrHandler.getTarget=function(attrName,$elt){var relativeRegex=/^(\+|>|~|:parent|<)/,$target=[],
targetSelector=$elt.attr("data-"+attrName)||$elt.attr("href")||$elt.attr("attrName");if(!_.isEmpty(targetSelector)){var matches=relativeRegex.exec(targetSelector);if(null!==matches){var selector=targetSelector.replace(relativeRegex,"");$target=":parent"===matches[0]||"<"===matches[0]?$elt.parents(selector):"~"===matches[0]?$elt.siblings(selector):"+"===matches[0]?$elt.next(selector):$(selector,$elt)}else $target=$(targetSelector)}return $target},DataAttrHandler}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("lodash"),require("context")):"function"==typeof define&&define.amd?define("util/url",[
"lodash","context"],factory):(global=global||self)["util/url"]=factory(global._,global.context)}(this,function(_,context){"use strict";_=_&&_.hasOwnProperty("default")?_.default:_,context=context&&context.hasOwnProperty("default")?context.default:context;var parsers={absolute:/^(?:[a-z]+:)?\/\//i,base64:/^data:[^\/]+\/[^;]+(;charset=[\w]+)?;base64,/,query:/(?:^|&)([^&=]*)=?([^&]*)/g,url:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/};return{parse:function(url){var matches,keys=["source","protocol","authority","userInfo","user","password","host","port","relative","path"
,"directory","file","queryString","hash"],i=keys.length,parsed=Object.create({toString:function(){return this.source}});if(parsed.base64=parsers.base64.test(url),parsed.base64)parsed.source=url;else{for(matches=parsers.url.exec(url);i--;)parsed[keys[i]]=matches[i]||"";parsed.query={},parsed.queryString.replace(parsers.query,function($0,$1,$2){$1&&(parsed.query[$1]=$2)})}return parsed},isAbsolute:function(url){return"object"==typeof url&&url.hasOwnProperty("source")?url.source!==url.relative:"string"==typeof url?parsers.absolute.test(url):void 0},isRelative:function(url){var absolute=this.isAbsolute(url);if("boolean"==typeof absolute)return!absolute},
isBase64:function(url){return"object"==typeof url&&url.hasOwnProperty("source")?url.base64:"string"==typeof url?parsers.base64.test(url):void 0},encodeAsXmlAttr:function(uri){return/[<>&']+/.test(uri)?encodeURIComponent(uri):uri},build:function(path,params){var url,hasQueryString,queryString="";return path&&(_.isString(path)&&(url=path),_.isArray(path)&&(url="",_.forEach(path,function(chunk){/\/$/.test(url)&&/^\//.test(chunk)?url+=chunk.substr(1):""===url||/\/$/.test(url)||/^\//.test(chunk)?url+=chunk:url+="/"+chunk})),_.isPlainObject(params)&&(hasQueryString=-1<url.indexOf("?"),queryString=_.reduce(params,function(acc,value,key){return _.isEmpty(acc
)&&!hasQueryString||(acc+="&"),"object"!=typeof value||_.isArray(value)?acc+=encodeURIComponent(key)+"="+encodeURIComponent(value):_.forOwn(value,function(parameterValue,parameterName){acc+=encodeURIComponent(key)+"["+encodeURIComponent(parameterName)+"]="+encodeURIComponent(parameterValue)+"&"}),acc},queryString),_.isEmpty(queryString)||(hasQueryString||(url+="?"),url+=queryString))),url},route:function(action,controller,extension,params,rootUrl){var routeParts=[extension,controller,action];if(_.some(routeParts,function(value){return _.isEmpty(value)||!_.isString(value)}))throw new TypeError("All parts are required to build an URL")
;return rootUrl=rootUrl||context&&context.root_url,this.build([rootUrl].concat(routeParts),params)}}}),define("taoClientDiagnostic/tools/fixedDecimals",[],function(){"use strict";return function(value,decimals){var shift=Math.pow(10,Math.abs(decimals||1));return Math.round(Number(value)*shift)/shift||0}}),define("taoClientDiagnostic/tools/stats",["lodash","taoClientDiagnostic/tools/fixedDecimals"],function(_,fixedDecimals){"use strict";return function(list,fieldName,decimals){var variance,avg,med,middle,getValue,results,sum=0,sum2=0,min=Number.MAX_VALUE,max=0,count=0,values=[];return getValue=_.isFunction(fieldName)?fieldName:function(item){
return item&&item[fieldName]||0},_.forEach(list,function(item){var value;void 0!==item&&(value=getValue(item),values.push(value),min=Math.min(min,value),max=Math.max(max,value),sum+=value,count++)}),avg=sum/(count||1),_.forEach(values,function(value){var diff=value-avg;sum2+=diff*diff}),variance=1<count?Math.sqrt(sum2/(count-1)):0,values.sort(),middle=count/2,med=(values[Math.floor(middle)]+values[Math.ceil(middle)])/2,results={min:min,max:max,sum:sum,count:count,average:avg,median:med,variance:variance},decimals&&_.forEach(results,function(value,key){results[key]=fixedDecimals(value,decimals)}),results.values=list,results}}),define(
"taoClientDiagnostic/tools/getConfig",["lodash"],function(_){"use strict";return function(config,defaults){return _(config||{}).omit(function(value){return null==value}).defaults(defaults||{}).value()}}),define("taoClientDiagnostic/tools/getLabels",["lodash"],function(_){"use strict";return function(messages,level){return messages=messages||{},_.isArray(messages)||(messages=[messages]),messages[level=Math.min(Math.max(parseInt(level,10)||0,1),messages.length||1)-1]||{}}}),define("taoClientDiagnostic/tools/getStatus",["lodash"],function(_){"use strict";return function(percentage,thresholds,opts){var len,feedback,i,step,options=opts||{},
testPercentage=Math.max(0,Math.min(100,Math.round(parseInt(percentage,10)||0))),status={percentage:testPercentage,globalPercentage:options.minimumGlobalPercentage?Math.max(testPercentage,options.minimumGlobalPercentage):testPercentage,quality:{}};if(thresholds){for(_.isArray(thresholds)||(thresholds=[thresholds]),len=thresholds.length,i=0;i<len&&((step=thresholds[i])&&(!step.threshold||status.percentage>=step.threshold));i++)feedback=step;feedback&&(status.feedback=_.clone(feedback))}return status}}),define("taoClientDiagnostic/tools/performances/tester",["jquery","lodash","i18n","async","context","helpers","taoClientDiagnostic/tools/stats",
"taoQtiItem/qtiItem/core/Loader","taoQtiItem/qtiCommonRenderer/renderers/Renderer","taoClientDiagnostic/tools/getConfig","taoClientDiagnostic/tools/getLabels","taoClientDiagnostic/tools/getStatus"],function($,_,__,async,context,helpers,stats,Loader,Renderer,getConfig,getLabels,getStatus){"use strict";var _second=1e3,_defaultTimeout=30*_second,_defaultSamples=["taoClientDiagnostic/tools/performances/data/sample1/","taoClientDiagnostic/tools/performances/data/sample2/","taoClientDiagnostic/tools/performances/data/sample3/"],_defaults={id:"performances",optimal:.025,threshold:.25},_thresholds=[{threshold:0,message:__("Very slow performances"),type:"error"},{
threshold:33,message:__("Average performances"),type:"warning"},{threshold:66,message:__("Good performances"),type:"success"}],_messages=[{title:__("Workstation performances"),status:__("Checking the performances..."),performancesMin:__("Minimum rendering time"),performancesMax:__("Maximum rendering time"),performancesAverage:__("Average rendering time")}];function loadItem(data,done){var qtiJsonFile=data.url+"qti.json",extension=data.url.split("/")[0],fullpath=require.s.contexts._.config.paths[extension],baseUrl=data.url.replace(extension,fullpath),loader=new Loader,renderer=new Renderer({baseUrl:baseUrl});renderer.getAssetManager&&renderer.getAssetManager(
).setData("baseUrl",baseUrl),require(["json!"+qtiJsonFile],function(itemData){loader.loadItemData(itemData,function(item){renderer.load(function(){var $container,duration,start,result;start=window.performance.now(),item.setRenderer(this),($container=$("<div>").appendTo("body")).append(item.render()),item.postRender(),$container.remove(),duration=(window.performance.now()-start)/_second,result={id:data.id,url:data.url,duration:duration},done(null,result)},this.getLoadedClasses())})})}return function(config){var initConfig=getConfig(config,_defaults),labels=getLabels(_messages,initConfig.level),idx=0,_samples=_.map(!_.isEmpty(initConfig.samples
)&&initConfig.samples||_defaultSamples,function(sample){return{id:"sample"+ ++idx,url:sample,timeout:1e3*initConfig.timeout||_defaultTimeout,nb:initConfig.occurrences||10}});return _samples[0].nb++,{start:function(done){var tests=[],self=this;_.forEach(_samples,function(data){for(var cb=_.partial(loadItem,data),iterations=data.nb||1;iterations--;)tests.push(cb)}),async.series(tests,function(err,measures){var results,status,summary;if(err&&!measures.length)throw err;measures.shift(),results=stats(measures,"duration",2),status=self.getFeedback(results.average),summary=self.getSummary(results),done(status,summary,results)})},get labels(){return labels},
getSummary:function(results){return{performancesMin:{message:labels.performancesMin,value:results.min+" s"},performancesMax:{message:labels.performancesMax,value:results.max+" s"},performancesAverage:{message:labels.performancesAverage,value:results.average+" s"}}},getFeedback:function(result){var optimal=initConfig.optimal,range=Math.abs(optimal-initConfig.threshold),status=getStatus((range+optimal-result)/range*100,_thresholds);return status.title=labels.title,status.id=initConfig.id,status}}}}),define("taoClientDiagnostic/tools/bandwidth/tester",["lodash","i18n","async","context","taoClientDiagnostic/tools/getConfig","taoClientDiagnostic/tools/getLabels",
"taoClientDiagnostic/tools/stats","taoClientDiagnostic/tools/fixedDecimals","taoClientDiagnostic/tools/getStatus"],function(_,__,async,context,getConfig,getLabels,stats,fixedDecimals,getStatus){"use strict";var _mega=1048576,_second=1e3,_thresholds=[{threshold:0,message:__("Low bandwidth"),type:"error"},{threshold:33,message:__("Average bandwidth"),type:"warning"},{threshold:66,message:__("Good bandwidth"),type:"success"}],_defaults={id:"bandwidth",unit:.16,ideal:45,max:100,minimumGlobalPercentage:!1,feedbackThresholds:_thresholds,fallbackThreshold:.2},_downloadData={"10KB":{id:"10KB",file:"data/bin10KB.data",size:10240,timeout:_second,threshold:0,nb:10},
"100KB":{id:"100KB",file:"data/bin100KB.data",size:102400,timeout:2*_second,threshold:0,nb:5},"1MB":{id:"1MB",file:"data/bin1MB.data",size:_mega,timeout:20*_second,threshold:0,nb:3}},_messages=[{title:__("Bandwidth"),status:__("Checking the bandwidth..."),legend:__("Number of simultaneous test takers the connection can handle"),bandwidthMin:__("Minimum bandwidth"),bandwidthMax:__("Maximum bandwidth"),bandwidthAverage:__("Average bandwidth")},{title:__("Media intensive bandwidth"),status:__("Checking the media intensive bandwidth..."),legend:__("Number of simultaneous test takers the connection can handle with media intensive"),bandwidthMin:__(
"Minimum intensive bandwidth"),bandwidthMax:__("Maximum intensive bandwidth"),bandwidthAverage:__("Average intensive bandwidth")}];function download(data,cb){var start,end,timeoutId,url,request,self=this;if(data.threshold&&this.bandwidth<data.threshold)return cb("threshold");url=context.root_url+"taoClientDiagnostic/views/js/tools/bandwidth/"+data.file+"?"+Date.now(),(request=new XMLHttpRequest).open("GET",url,!0),request.setRequestHeader("Accept","application/octet-stream"),request.onload=function(){var duration,speed;return end=window.performance.now(),clearTimeout(timeoutId),duration=end-start,speed=8*data.size/(duration/_second)/_mega,
self.bandwidth=Math.max(self.bandwidth,speed),cb(null,{id:data.id,file:data.file,size:data.size,duration:duration,speed:speed})},request.onerror=function(err){clearTimeout(timeoutId),cb(err)},request.onreadystatechange=function(){4===request.readyState&&200!==request.status&&(clearTimeout(timeoutId),cb(request.status))},timeoutId=_.delay(cb,data.timeout,"timeout"),start=window.performance.now(),request.send()}return function(config){var initConfig=getConfig(config,_defaults),labels=getLabels(_messages,initConfig.level);return _.isArray(initConfig.feedbackThresholds)&&!initConfig.feedbackThresholds.length&&(initConfig.feedbackThresholds=_thresholds),{
start:function(done){var self=this,tests=[];_.forEach(_downloadData,function(data){for(var cb=_.bind(download,self,data),iterations=data.nb||1;iterations--;)tests.push(cb)}),this.bandwidth=0,async.series(tests,function(err,measures){var results,summary,status,duration=0,size=0;if(err&&!measures.length)throw err;(results=stats(measures,function(value){var speed=0;return value&&(duration+=value.duration,size+=value.size,speed=value.speed,value.speed=fixedDecimals(speed,2)),speed},2)).duration=fixedDecimals(duration/_second,2),results.size=size,summary=self.getSummary(results),status=self.getFeedback(results),done(status,summary,results)})},get labels(){
return labels},getSummary:function(results){return{bandwidthMin:{message:labels.bandwidthMin,value:results.min+" Mbps"},bandwidthMax:{message:labels.bandwidthMax,value:results.max+" Mbps"},bandwidthAverage:{message:labels.bandwidthAverage,value:results.average+" Mbps"}}},getFeedback:function(result){var status,nb,avgResult=result.average,bandwidthUnit=initConfig.unit,threshold=initConfig.ideal,maxTestTakers=initConfig.max,max=threshold*bandwidthUnit,getStatusOptions=initConfig.minimumGlobalPercentage?{minimumGlobalPercentage:initConfig.minimumGlobalPercentage}:{},baseBandwidth=avgResult;return result.min/avgResult>initConfig.fallbackThreshold&&(
baseBandwidth=result.min),status=getStatus(baseBandwidth/max*100,initConfig.feedbackThresholds,getStatusOptions),maxTestTakers<(nb=Math.floor(baseBandwidth/bandwidthUnit))&&(nb=">"+maxTestTakers),status.id=initConfig.id,status.title=labels.title,status.feedback.legend=labels.legend,2<(status.quality.label=nb).toString().length&&(status.quality.wide=!0),status}}}}),define("taoClientDiagnostic/tools/upload/tester",["jquery","lodash","i18n","async","util/url","taoClientDiagnostic/tools/getConfig","taoClientDiagnostic/tools/getLabels","taoClientDiagnostic/tools/getStatus"],function($,_,__,async,urlHelper,getConfig,getLabels,getStatus){"use strict";var data=[],
_defaults={id:"upload",size:1048576,optimal:1048576},_thresholds=[{threshold:0,message:__("Low upload speed"),type:"error"},{threshold:33,message:__("Average upload speed"),type:"warning"},{threshold:66,message:__("Good upload speed"),type:"success"}],_messages=[{title:__("Upload speed"),status:__("Checking upload speed..."),uploadAvg:__("Average upload speed"),uploadMax:__("Max upload speed")}],upload=function(size){var url=urlHelper.route("upload","CompatibilityChecker","taoClientDiagnostic",{cache:Date.now()}),str=function(length){var i,text="",possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(i=0;i<length;i++
)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text}(size);return data=[],$.ajax({url:url,type:"POST",data:{upload:str},xhr:function(){var xhr=new window.XMLHttpRequest,startTime=Date.now();return xhr.upload.addEventListener("progress",function(evt){var passedTime;evt.lengthComputable&&(passedTime=Date.now()-startTime,data.push({time:passedTime,loaded:evt.loaded,speed:8*evt.loaded/1048576/(passedTime/1e3)}))},!1),xhr}})};return function(config){var initConfig=getConfig(config,_defaults),labels=getLabels(_messages,initConfig.level);return{start:function(done){var self=this;upload(parseInt(initConfig.size,10)).then(function(){
var avgSpeed,status,summary,results,totalSpeed=0,maxSpeed=0;_.forEach(data,function(val){totalSpeed+=val.speed,maxSpeed<val.speed&&(maxSpeed=Math.round(100*val.speed)/100)}),avgSpeed=Math.round(totalSpeed/data.length*100)/100,results={max:maxSpeed,avg:avgSpeed,type:"upload"},status=self.getFeedback(avgSpeed),summary=self.getSummary(results),done(status,summary,results)})},get labels(){return labels},getSummary:function(results){return{uploadAvg:{message:labels.uploadAvg,value:results.avg+" Mbps"},uploadMax:{message:labels.uploadMax,value:results.max+" Mbps"}}},getFeedback:function(result){var optimal=initConfig.optimal/1048576,status=getStatus(
100/optimal*result,_thresholds);return status.id=initConfig.id,status.title=labels.title,status}}}}),define("taoClientDiagnostic/tools/getPlatformInfo",["jquery","util/url","core/promise","taoClientDiagnostic/tools/getConfig"],function($,url,Promise,getConfig){"use strict";var defaultConfig={browserVersionAction:"whichBrowser",browserVersionController:"CompatibilityChecker",browserVersionExtension:"taoClientDiagnostic"};return function(win,config){var testerUrl;return config=getConfig(config,defaultConfig),testerUrl=function(win,action,controller,extension){var document=win.document,navigator=win.navigator,screen=win.screen,params={},e=0,f=0
;return params.ua=navigator.userAgent,e|=win.ActiveXObject?1:0,e|=win.opera?2:0,e|=win.chrome?4:0,e|="getBoxObjectFor"in document||"mozInnerScreenX"in win?8:0,e|="WebKitCSSMatrix"in win||"WebKitPoint"in win||"webkitStorageInfo"in win||"webkitURL"in win?16:0,e|=16&e&&-1==={}.toString.toString().indexOf("\n")?32:0,params.e=e,f|="sandbox"in document.createElement("iframe")?1:0,f|="WebSocket"in win?2:0,f|=win.Worker?4:0,f|=win.applicationCache?8:0,f|=win.history&&win.history.pushState?16:0,f|=document.documentElement.webkitRequestFullScreen?32:0,f|="FileReader"in win?64:0,params.f=f,params.r=Math.random().toString(36).substring(7),params.w=screen.width,
params.h=screen.height,url.route(action,controller,extension,params)}(win,config.browserVersionAction,config.browserVersionController,config.browserVersionExtension),new Promise(function(resolve,reject){$.ajax({url:testerUrl}).done(resolve).fail(reject)})}}),define("taoClientDiagnostic/tools/browser/tester",["jquery","i18n","util/url","taoClientDiagnostic/tools/getConfig","taoClientDiagnostic/tools/getLabels","taoClientDiagnostic/tools/getPlatformInfo","taoClientDiagnostic/tools/getStatus"],function($,__,url,getConfig,getLabels,getPlatformInfo,getStatus){"use strict";var _defaults={id:"browser",browserVersionAction:"whichBrowser",
browserVersionController:"CompatibilityChecker",browserVersionExtension:"taoClientDiagnostic",action:"check",controller:"DiagnosticChecker"},_placeHolders_CURRENT_BROWSER="%CURRENT_BROWSER%",_placeHolders_CURRENT_OS="%CURRENT_OS%",_messages=[{title:__("Operating system and web browser"),status:__("Checking the browser..."),browser:__("Web browser"),os:__("Operating system")}];return function(config){var initConfig=getConfig(config,_defaults),labels=getLabels(_messages,initConfig.level);return{start:function(done){var self=this;getPlatformInfo(window,initConfig).then(function(results){$.post(url.route(initConfig.action,initConfig.controller,
initConfig.extension),results,function(data){var percentage="success"===data.type?100:"warning"===data.type?33:0,status=self.getFeedback(percentage,data),summary=self.getSummary(results);status.customMsgRenderer=function(customMsg){return(customMsg||"").replace(_placeHolders_CURRENT_BROWSER,summary.browser.value).replace(_placeHolders_CURRENT_OS,summary.os.value)},done(status,summary,results)},"json")})},get labels(){return labels},getSummary:function(results){var currentBrowser=results.browser+" "+results.browserVersion,currentOs=results.os+" "+results.osVersion;return{browser:{message:labels.browser,value:currentBrowser},os:{message:labels.os,
value:currentOs}}},getFeedback:function(result,data){var status=getStatus(result,data);return status.id=initConfig.id,status.title=labels.title,status}}}}),define("tpl!taoClientDiagnostic/tools/diagnostic/tpl/main",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,helper,buffer="",functionType="function",escapeExpression=this.escapeExpression,helperMissing=helpers.helperMissing,self=this;function program8(depth0,data){var helper,options,buffer=""
;return buffer+='\n        <p>\n            <label for="school_number">'+escapeExpression((options={hash:{},data:data},(helper=helpers.__||depth0&&depth0.__)?helper.call(depth0,"School number:",options):helperMissing.call(depth0,"__","School number:",options)))+'</label>\n            <input type="text" data-control="school_number" id="school_number" name="school_number" maxlength="10" placeholder="'+escapeExpression((options={hash:{},data:data},(helper=helpers.__||depth0&&depth0.__)?helper.call(depth0,"School number",options):helperMissing.call(depth0,"__","School number",options))
)+'" />\n        </p>\n        <p>\n            <label for="school_pin">'+escapeExpression((options={hash:{},data:data},(helper=helpers.__||depth0&&depth0.__)?helper.call(depth0,"School PIN:",options):helperMissing.call(depth0,"__","School PIN:",options)))+'</label>\n            <input type="text" data-control="school_pin" id="school_pin" name="school_pin" maxlength="4" placeholder="'+escapeExpression((options={hash:{},data:data},(helper=helpers.__||depth0&&depth0.__)?helper.call(depth0,"School PIN code (4 digits)",options):helperMissing.call(depth0,"__","School PIN code (4 digits)",options)))+'" />\n        </p>\n            '}function program10(depth0,data
){var helper,options,buffer="";return buffer+='\n        <p>\n            <label for="school_name">'+escapeExpression((options={hash:{},data:data},(helper=helpers.__||depth0&&depth0.__)?helper.call(depth0,"School name:",options):helperMissing.call(depth0,"__","School name:",options)))+'</label>\n            <input type="text" data-control="school_name" id="school_name" name="school_name" maxlength="255" placeholder="'+escapeExpression((options={hash:{},data:data},(helper=helpers.__||depth0&&depth0.__)?helper.call(depth0,"School name",options):helperMissing.call(depth0,"__","School name",options)))+'" />\n        </p>\n            '}
return buffer+='<div class="diagnostics-main-area">\n\n    <h1>',stack1=(helper=helpers.title)?helper.call(depth0,{hash:{},data:data}):typeof(helper=depth0&&depth0.title)===functionType?helper.call(depth0,{hash:{},data:data}):helper,buffer+=escapeExpression(stack1)+'</h1>\n\n    <div class="intro">\n        ',!(stack1=helpers.if.call(depth0,depth0&&depth0.header,{hash:{},inverse:self.noop,fn:self.program(1,function(depth0,data){var stack1,helper,buffer="";return buffer+="<p>",stack1=(helper=helpers.header)?helper.call(depth0,{hash:{},data:data}):typeof(helper=depth0&&depth0.header)===functionType?helper.call(depth0,{hash:{},data:data}):helper,
buffer+=escapeExpression(stack1)+"</p>"},data),data:data}))&&0!==stack1||(buffer+=stack1),buffer+="\n        ",!(stack1=helpers.if.call(depth0,depth0&&depth0.info,{hash:{},inverse:self.noop,fn:self.program(3,function(depth0,data){var stack1,helper,buffer="";return buffer+="<p>",stack1=(helper=helpers.info)?helper.call(depth0,{hash:{},data:data}):typeof(helper=depth0&&depth0.info)===functionType?helper.call(depth0,{hash:{},data:data}):helper,buffer+=escapeExpression(stack1)+"</p>"},data),data:data}))&&0!==stack1||(buffer+=stack1),buffer+="\n        ",!(stack1=helpers.if.call(depth0,depth0&&depth0.setup,{hash:{},inverse:self.noop,fn:self.program(5,function(
depth0,data){var stack1,helper,buffer="";return buffer+="<p>",stack1=(helper=helpers.setup)?helper.call(depth0,{hash:{},data:data}):typeof(helper=depth0&&depth0.setup)===functionType?helper.call(depth0,{hash:{},data:data}):helper,buffer+=escapeExpression(stack1)+"</p>"},data),data:data}))&&0!==stack1||(buffer+=stack1),buffer+="\n        ",!(stack1=helpers.if.call(depth0,depth0&&depth0.requireSchoolName,{hash:{},inverse:self.noop,fn:self.program(7,function(depth0,data){var stack1,buffer="";return buffer+="\n            ",!(stack1=helpers.if.call(depth0,depth0&&depth0.validateSchoolName,{hash:{},inverse:self.program(10,program10,data),fn:self.program(8,
program8,data),data:data}))&&0!==stack1||(buffer+=stack1),buffer+="\n        "},data),data:data}))&&0!==stack1||(buffer+=stack1),buffer+='\n    </div>\n\n    <div class="clearfix">\n        <button data-action="test-launcher" class="btn-info small rgt">',stack1=(helper=helpers.button)?helper.call(depth0,{hash:{},data:data}):typeof(helper=depth0&&depth0.button)===functionType?helper.call(depth0,{hash:{},data:data}):helper,buffer+=escapeExpression(stack1)+'</button>\n    </div>\n\n    <ul class="plain results"></ul>\n\n    <div class="status">\n        <h2></h2>\n    </div>\n\n</div>'})}),define("tpl!taoClientDiagnostic/tools/diagnostic/tpl/result",[
"handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],data=data||{};var stack1,helper,buffer="",helperMissing=(helpers=this.merge(helpers,Handlebars.helpers)).helperMissing,escapeExpression=this.escapeExpression;return buffer+='<li data-result="',stack1=(helper=helpers.id)?helper.call(depth0,{hash:{},data:data}):"function"==typeof(helper=depth0&&depth0.id)?helper.call(depth0,{hash:{},data:data}):helper,buffer+=escapeExpression(stack1)+'">\n    <h2>',stack1=(helper=helpers.title)?helper.call(depth0,{hash:{},data:data}):"function"==typeof(helper=depth0&&depth0.title)?helper.call(depth0,
{hash:{},data:data}):helper,buffer+=escapeExpression(stack1)+'</h2>\n    <div class="result"></div>\n\n    ',!(stack1=helpers.if.call(depth0,depth0&&depth0.details,{hash:{},inverse:this.noop,fn:this.program(1,function(depth0,data){var helper,options,buffer="";return buffer+='\n    <div class="clearfix">\n        <button data-action="show-details" class="rgt btn-info small">'+escapeExpression((options={hash:{},data:data},(helper=helpers.__||depth0&&depth0.__)?helper.call(depth0,"Show Details",options):helperMissing.call(depth0,"__","Show Details",options))
)+'</button>\n        <button data-action="hide-details" class="rgt btn-info small hidden">'+escapeExpression((options={hash:{},data:data},(helper=helpers.__||depth0&&depth0.__)?helper.call(depth0,"Hide Details",options):helperMissing.call(depth0,"__","Hide Details",options)))+'</button>\n        <div class="details hidden"></div>\n    </div>\n    '},data),data:data}))&&0!==stack1||(buffer+=stack1),buffer+="\n</li>"})}),define("tpl!taoClientDiagnostic/tools/diagnostic/tpl/details",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),
data=data||{};var stack1,helper,options,buffer="",functionType="function",escapeExpression=this.escapeExpression,helperMissing=helpers.helperMissing;return buffer+='<div class="details">\n    <h2>'+escapeExpression((options={hash:{},data:data},(helper=helpers.__||depth0&&depth0.__)?helper.call(depth0,"Details",options):helperMissing.call(depth0,"__","Details",options)))+'</h2>\n    <div>\n        <table class="matrix">\n            <tbody>\n            ',!(stack1=helpers.each.call(depth0,depth0,{hash:{},inverse:this.noop,fn:this.program(1,function(depth0,data){var stack1,helper,buffer="";return buffer+="\n                <tr><td>",stack1=(
helper=helpers.message)?helper.call(depth0,{hash:{},data:data}):typeof(helper=depth0&&depth0.message)===functionType?helper.call(depth0,{hash:{},data:data}):helper,buffer+=escapeExpression(stack1)+"</td><td>",stack1=(helper=helpers.value)?helper.call(depth0,{hash:{},data:data}):typeof(helper=depth0&&depth0.value)===functionType?helper.call(depth0,{hash:{},data:data}):helper,buffer+=escapeExpression(stack1)+"</td></tr>\n            "},data),data:data}))&&0!==stack1||(buffer+=stack1),buffer+="\n            </tbody>\n        </table>\n    </div>\n</div>"})}),define("tpl!taoClientDiagnostic/tools/diagnostic/tpl/feedback",["handlebars"],function(hb){
return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,helper,buffer="",functionType="function",escapeExpression=this.escapeExpression;return buffer+='<div class="small feedback feedback-',stack1=(helper=helpers.type)?helper.call(depth0,{hash:{},data:data}):typeof(helper=depth0&&depth0.type)===functionType?helper.call(depth0,{hash:{},data:data}):helper,buffer+=escapeExpression(stack1)+'">\n    <span class="icon icon-',stack1=(helper=helpers.type)?helper.call(depth0,{hash:{},data:data}):typeof(helper=depth0&&depth0.type
)===functionType?helper.call(depth0,{hash:{},data:data}):helper,buffer+=escapeExpression(stack1)+'"></span>\n    <span class="msg">',stack1=(helper=helpers.message)?helper.call(depth0,{hash:{},data:data}):typeof(helper=depth0&&depth0.message)===functionType?helper.call(depth0,{hash:{},data:data}):helper,buffer+=escapeExpression(stack1)+"</span>\n    ",!(stack1=helpers.if.call(depth0,depth0&&depth0.legend,{hash:{},inverse:this.noop,fn:this.program(1,function(depth0,data){var stack1,helper,buffer="";return buffer+='<div class="legend">',stack1=(helper=helpers.legend)?helper.call(depth0,{hash:{},data:data}):typeof(helper=depth0&&depth0.legend
)===functionType?helper.call(depth0,{hash:{},data:data}):helper,buffer+=escapeExpression(stack1)+"</div>"},data),data:data}))&&0!==stack1||(buffer+=stack1),buffer+="\n    ",!(stack1=helpers.if.call(depth0,depth0&&depth0.customMsg,{hash:{},inverse:this.noop,fn:this.program(3,function(depth0,data){var stack1,helper,buffer="";return buffer+='<div class="customMsg">',stack1=(helper=helpers.customMsg)?helper.call(depth0,{hash:{},data:data}):typeof(helper=depth0&&depth0.customMsg)===functionType?helper.call(depth0,{hash:{},data:data}):helper,buffer+=escapeExpression(stack1)+"</div>"},data),data:data}))&&0!==stack1||(buffer+=stack1),buffer+="\n</div>"})}),define(
"tpl!taoClientDiagnostic/tools/diagnostic/tpl/quality-bar",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,buffer="",functionType="function",escapeExpression=this.escapeExpression;return buffer+='<div class="quality-bar">\n    <div class="quality-indicator',!(stack1=helpers.if.call(depth0,depth0&&depth0.wide,{hash:{},inverse:this.noop,fn:this.program(1,function(depth0,data){return" wide"},data),data:data}))&&0!==stack1||(buffer+=stack1),buffer+='"',!(stack1=helpers.if.call(depth0,depth0&&depth0.label,{
hash:{},inverse:this.noop,fn:this.program(3,function(depth0,data){var stack1,helper,buffer="";return buffer+=' title="',stack1=(helper=helpers.label)?helper.call(depth0,{hash:{},data:data}):typeof(helper=depth0&&depth0.label)===functionType?helper.call(depth0,{hash:{},data:data}):helper,buffer+=escapeExpression(stack1)+'"'},data),data:data}))&&0!==stack1||(buffer+=stack1),buffer+="></div>\n</div>"})}),define("css!taoClientDiagnosticCss/diagnostics",[],function(){}),define("taoClientDiagnostic/tools/diagnostic/diagnostic",["jquery","lodash","i18n","async","ui/feedback","ui/component","core/logger","core/store","core/promise","core/dataProvider/request",
"ui/dialog/alert","util/url","taoClientDiagnostic/tools/performances/tester","taoClientDiagnostic/tools/bandwidth/tester","taoClientDiagnostic/tools/upload/tester","taoClientDiagnostic/tools/browser/tester","taoClientDiagnostic/tools/getStatus","taoClientDiagnostic/tools/getConfig","tpl!taoClientDiagnostic/tools/diagnostic/tpl/main","tpl!taoClientDiagnostic/tools/diagnostic/tpl/result","tpl!taoClientDiagnostic/tools/diagnostic/tpl/details","tpl!taoClientDiagnostic/tools/diagnostic/tpl/feedback","tpl!taoClientDiagnostic/tools/diagnostic/tpl/quality-bar","css!taoClientDiagnosticCss/diagnostics"],function($,_,__,async,feedback,component,loggerFactory,store,
Promise,request,dialogAlert,urlUtil,performancesTester,bandwidthTester,uploadTester,browserTester,getStatus,getConfig,mainTpl,resultTpl,detailsTpl,feedbackTpl,qualityBarTpl){"use strict";var logger=loggerFactory("taoClientDiagnostic/diagnostic"),_defaults={title:__("System Compatibility"),header:__("This tool will run a number of tests in order to establish how well your current environment is suitable to run the TAO platform."),info:__("Be aware that these tests will take up to several minutes."),button:__("Test system compatibility"),actionStore:"storeData",actionSchool:"schoolName",controller:"DiagnosticChecker",extension:"taoClientDiagnostic",
actionDropId:"deleteId",storeAllRuns:!1,configurableText:{}},_thresholds=[{threshold:0,message:__("Your system requires a compatibility update, please contact your system administrator."),type:"error"},{threshold:33,message:__("Your system is not optimal, please contact your system administrator."),type:"warning"},{threshold:66,message:__("Your system is fully compliant."),type:"success"}],diagnostic={changeStatus:function(status){return this.is("rendered")&&this.controls.$status.html(status),this},store:function(type,details,done){var config=this.config;(details=_.omit(details,"values")).type=type,$.post(urlUtil.route(config.actionStore,config.controller,
config.extension,config.storeParams),details,done,"json")},getCustomMsg:function(key){return this.config.configurableText[key]},addCustomFeedbackMsg:function(status,msg){this.hasFailed(status)&&msg&&(_.isFunction(status.customMsgRenderer)&&(msg=status.customMsgRenderer(msg)),status.feedback=status.feedback||{},status.feedback.customMsg=msg)},hasFailed:function(result){return!(result&&result.feedback&&"success"===result.feedback.type)},addResult:function(result){var $main,$indicator,$result;return this.is("rendered")&&(result.quality&&result.quality.label&&2<result.quality.label.toString().length&&(result.quality.wide=!0),$result=($main=$(resultTpl(result))
).find(".result"),result.feedback&&$result.append($(feedbackTpl(result.feedback))),result.quality&&$result.append($(qualityBarTpl(result.quality))),result.details&&$main.find(".details").append($(detailsTpl(result.details))),$indicator=$main.find(".quality-indicator"),this.controls.$results.append($main),$main.fadeIn(function(){$indicator.length&&$indicator.animate({left:result.percentage*$main.outerWidth()/100-$indicator.outerWidth()/2})})),this},cleanUp:function(){return this.controls.$results.empty(),this},enable:function(){return this.controls.$start.removeClass("hidden"),this},disable:function(){return this.controls.$start.addClass("hidden"),this},
prepare:function(){return this.trigger("start"),this.changeStatus(__("Starting...")),this.setState("running",!0),this.setState("done",!1),this.cleanUp(),this.disable(),this},finish:function(){var config=this.config;return this.enable(),config.storeAllRuns&&this.deleteIdentifier(),this.trigger("end"),this.changeStatus(__("Done!")),this.setState("running",!1),this.setState("done",!0),this},deleteIdentifier:function(){var url=urlUtil.route(this.config.actionDropId,this.config.controller,this.config.extension);return request(url,null,"POST")},run:function(){function doRun(){self.is("rendered")&&(self.prepare(),_.forEach(self.config.testers,function(testerConfig,
testerId){testerConfig.id=testerConfig.id||testerId,testerConfig.enabled&&testers.push(function(cb){!function(testerConfig,cb){var testerId=testerConfig.id;self.trigger("starttester",testerId),self.setState(testerId,!0),require([testerConfig.tester],function(testerFactory){var tester=testerFactory(getConfig(testerConfig,self.config),self);self.changeStatus(tester.labels.status),tester.start(function(status,details,results){var customMsg;testerConfig.customMsgKey&&(customMsg=self.getCustomMsg(testerConfig.customMsgKey),self.addCustomFeedbackMsg(status,customMsg)),_.forEach(details,function(info){information.push(info)}),scores[status.id]=status,self.trigger(
"endtester",testerId,status),self.setState(testerId,!1),results=_.mapValues(results,function(value){switch(typeof value){case"boolean":return value?1:0;case"object":return JSON.stringify(value)}return value}),self.store(testerId,results,function(){self.addResult(status),cb()})})})}(testerConfig,cb)})}),async.series(testers,function(){var total=_.min(scores,"globalPercentage"),status=getStatus(total.globalPercentage,_thresholds);status.title=__("Total"),status.id="total",self.addCustomFeedbackMsg(status,self.config.configurableText.diagTotalCheckResult),status.details=information,self.addResult(status),self.finish()}))}var self=this,information=[],scores={},
testers=[],customInput=self.getCustomInput();return 0<_.size(customInput)?self.store("custom_input",customInput,doRun):doRun(),self},getCustomInput:function(){var vars={},self=this;return window.location.href.replace(location.hash,"").replace(/[?&]+([^=&]+)=?([^&]*)?/gi,function(m,key,value){_.has(self.config.customInput,key)&&(vars[key]=void 0!==value?value:"")}),vars}};return function(container,config){var diagComponent;return config&&_.forEach(["title","header","footer","info","button"],function(name){config[name]&&(config[name]=__(config[name]))}),diagComponent=component(diagnostic,_defaults).setTemplate(mainTpl).on("destroy",function(){
this.controls=null}).on("init",function(){this.render(container)}).on("render",function(){var self=this,launch=function(){runDiagnostics()};function runDiagnostics(data){data&&_.isPlainObject(data)&&(self.config.storeParams=_.assign(self.config.storeParams||{},data)),self.run()}function getControl(name){return self.controls["$"+name]}function getInputValue(name){var $control=getControl(name);return($control&&$control.val()||"").trim()}function toggleControl(name,state){var $control=getControl(name);$control&&(void 0===state&&(state=!$control.is(":enabled")),state?$control.removeProp("disabled"):$control.prop("disabled",!0))}function manageSchoolName(fields,
validate){function toggleStart(){var allow=_.every(fields,getInputValue);return toggleControl("start",allow),allow}function toggleFields(state){_.forEach(fields,function(fieldName){toggleControl(fieldName,state)})}_.forEach(fields,function(fieldName){self.controls["$"+fieldName]=self.getElement().find('[data-control="'+fieldName+'"]').on("keypress",function(e){var shouldStart=13===e.which;shouldStart&&e.preventDefault(),_.defer(function(){toggleStart()&&shouldStart&&self.controls.$start.click()})})}),toggleStart(),toggleFields(!1),store("client-diagnostic").then(function(storage){return self.on("start.school",function(){_.forEach(fields,function(fieldName){
storage.setItem(fieldName,getInputValue(fieldName)).catch(function(error){logger.error(error)})})}),Promise.all(_.map(fields,function(fieldName){return storage.getItem(fieldName).then(function(value){!function(name,value){var $control=getControl(name);$control&&$control.val(value)}(fieldName,value)})}))}).catch(function(error){logger.error(error)}).then(function(){toggleFields(!0),toggleStart()}),launch=function(){var values=_.reduce(fields,function(result,fieldName){return result[fieldName]=getInputValue(fieldName),result},{});self.changeStatus(__("Getting school name...")).cleanUp().disable(),_.isFunction(validate)?validate(values).then(runDiagnostics
).catch(function(error){var response=error.response||{},message=response.errorMsg||response.errorMessage||__("An error occurred! Please verify your input!");dialogAlert(message),logger.error(error),self.changeStatus(__("Failed to get school name")).enable()}):runDiagnostics(values)},self.on("start.school",function(){toggleFields(!1)}).on("end.school",function(){toggleFields(!0)})}this.controls={$start:this.$component.find('[data-action="test-launcher"]'),$status:this.$component.find(".status h2"),$results:this.$component.find(".results")},this.controls.$start.on("click",function(){self.controls.$start.is(":enabled")&&launch()}),
this.config.requireSchoolName&&(this.config.validateSchoolName?manageSchoolName(["school_number","school_pin"],function(values){var componentConfig=self.config;return request(urlUtil.route(componentConfig.actionSchool,componentConfig.controller,componentConfig.extension),values,"POST").then(function(data){return{school_name:data,school_number:values.school_number}})}):manageSchoolName(["school_name"])),this.controls.$results.on("click",'button[data-action="show-details"]',function(){var $btn=$(this).closest("button"),$result=$btn.closest("[data-result]");$result.find(".details").removeClass("hidden"),$btn.addClass("hidden"),$result.find(
'[data-action="hide-details"]').removeClass("hidden")}),this.controls.$results.on("click",'button[data-action="hide-details"]',function(){var $btn=$(this).closest("button"),$result=$btn.closest("[data-result]");$result.find(".details").addClass("hidden"),$btn.addClass("hidden"),$result.find('[data-action="show-details"]').removeClass("hidden")})}),_.defer(function(){diagComponent.init(config)}),diagComponent}}),function(c){var d=document,a="appendChild",i="styleSheet",s=d.createElement("style");s.type="text/css",d.getElementsByTagName("head")[0][a](s),s[i]?s[i].cssText=c:s[a](d.createTextNode(c))}(
'.diagnostics-content-area{max-width:768px;margin:40px auto 40px auto}.diagnostics-main-area{margin:40px auto 0 auto;background:#f3f1ef;border:1px solid #ddd;border-radius:2px;-webkit-border-radius:2px;padding:20px}.diagnostics-main-area h1,.diagnostics-main-area h2,.diagnostics-main-area h3{font-style:normal;font-family:"Century Gothic",CenturyGothic,AppleGothic,sans-serif}.diagnostics-main-area h1{margin-bottom:20px;font-size:20px;font-size:2rem}.diagnostics-main-area h2{margin:0;font-size:14px;font-size:1.4rem}.diagnostics-main-area h3{margin-top:10px;margin-bottom:5px;font-size:12px;font-size:1.2rem}.diagnostics-main-area .status h2,.diagnostics-main-area .details h2{margin:1rem 0}.diagnostics-main-area .legend{font-style:italic;font-weight:normal;font-family:"Century Gothic",CenturyGothic,AppleGothic,sans-serif;font-size:11px;font-size:1.1rem}.diagnostics-main-area .customMsg{margin-top:10px}.diagnostics-main-area .quality-bar{height:15px;background:linear-gradient(to right, #CE1431 0%, #D57915 25%, #D5A215 50%, #D5CB15 75%, #36B111 100%);opacity:.8;-moz-border-radius:2px;-webkit-border-radius:2px;border-radius:2px;margin:5px 0 10px;position:relative}.diagnostics-main-area .quality-indicator{position:absolute;border-width:10px 8px;border-style:solid;border-color:#333 transparent transparent;top:-1px;height:25px;width:0}.diagnostics-main-area .quality-indicator[title]:before{font-size:11px;font-size:1.1rem;content:attr(title);position:absolute;top:-36px;left:-12px;text-align:center;width:24px;height:24px;line-height:24px;display:inline-block;background-color:#0e5d91;color:rgba(255,255,255,0.9);-moz-border-radius:12px;-webkit-border-radius:12px;border-radius:12px}.diagnostics-main-area .quality-indicator.wide[title]:before{left:-16px;width:32px}.diagnostics-main-area [data-result],.diagnostics-main-area .bandwidth-box{display:none}.diagnostics-main-area [data-action=bandwidth-launcher]{margin:5px 0 10px}.diagnostics-main-area li{padding-bottom:10px}.diagnostics-main-area .intro{margin-bottom:20px}.diagnostics-main-area .intro label{display:inline-block;width:150px}table.datatable [class^="icon-"]{padding:0}table.datatable td{font-size:90%;font-weight:normal}table.datatable .progress .state:not(:first-child):before{content:\' - \'}table.datatable .progress .item-time:before{content:\' (\'}table.datatable .progress .item-time .total:before{content:\' / \'}table.datatable .progress .item-time:after{content:\')\'}.details table.matrix{border:1px solid #ddd;border-radius:2px;-webkit-border-radius:2px;margin-top:5px}.details table.matrix td:first-child{min-width:30%}.diagnostic-scope h1{font-family:"Century Gothic",CenturyGothic,AppleGothic,sans-serif;font-size:22px;font-size:2.2rem;font-weight:normal}.diagnostic-scope h2{font-family:"Century Gothic",CenturyGothic,AppleGothic,sans-serif;font-size:18px;font-size:1.8rem;margin:30px 0 10px}.diagnostic-scope form.daterange label{padding:0}.diagnostic-scope form.daterange input{margin:0 10px}.diagnostic-scope table.datatable [class^="icon-"]{padding:0}.diagnostic-scope table.datatable td{font-size:90%;font-weight:normal}.diagnostic-scope .content{margin:auto}.diagnostic-scope .diagnostic-index .content,.diagnostic-scope .diagnostic-runner .content{width:100%}.diagnostic-scope .diagnostic-index .message,.diagnostic-scope .diagnostic-runner .message{padding:8px;text-align:center}.diagnostic-scope .panel .action-bar{background:#266d9c;padding:3px;overflow:hidden;color:#e7eff4}.diagnostic-scope .panel .action-bar .btn-info{overflow:hidden;background:transparent;border:1px rgba(255,255,255,0.3) solid}.diagnostic-scope .diagnostics-main-area{margin-top:0px;max-width:800px}.diagnostic-scope .detailed-value{display:flex;justify-content:space-between}.diagnostic-scope .detailed-value.errors{color:#d8ae5b}.diagnostic-scope .detailed-value .details{font-size:2rem;cursor:pointer;color:#3e7da7}.diagnostic-scope .detailed-value .details:hover{color:#03131d}.action-bar .tool-exitButton,.action-bar [data-control="exitButton"]{float:right}\n\n/*# sourceMappingURL=diagnostics.css.map */'
),define("taoClientDiagnostic/loader/diagnostic.bundle",function(){}),window.bundles=(window.bundles||[]).concat(["taoQtiItem/loader/taoQtiItem.min","taoItems/loader/taoItems.min"]);
//# sourceMappingURL=diagnostic.min.js.map